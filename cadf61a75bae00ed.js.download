;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="ad624414-2981-3eee-fb25-50444c135e8d")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,693482,e=>{"use strict";var t=e.i(701105);function n(e){return new t._(e)}e.s(["_",()=>n])},231693,e=>{"use strict";var t=e.i(40036).ContextAPI.getInstance();e.s(["context",()=>t])},164760,619379,e=>{"use strict";var t,n,i,s;(i=t||(t={}))[i.INTERNAL=0]="INTERNAL",i[i.SERVER=1]="SERVER",i[i.CLIENT=2]="CLIENT",i[i.PRODUCER=3]="PRODUCER",i[i.CONSUMER=4]="CONSUMER",e.s(["SpanKind",()=>t],164760),(s=n||(n={}))[s.UNSET=0]="UNSET",s[s.OK=1]="OK",s[s.ERROR=2]="ERROR",e.s(["SpanStatusCode",()=>n],619379)},227062,472278,364520,792129,627922,562563,e=>{"use strict";var t,n,i=e.i(394212),s=e.i(297083),o=e.i(904851),r=e.i(90659),a=e.i(721281),c=e.i(167626),l=e.i(878420),u=e.i(64386),d=e.i(530658),h=e.i(346715),f=e.i(817556),g=e.i(960933),v=e.i(132592),p=e.i(50452),y=e.i(164760),m=e.i(619379),_=e.i(231693),k=e.i(783942),S=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),w={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},b={set:function(e,t,n){null!=e&&(e[t]=n)}},C=e.i(40036),E=(0,e.i(908564).createContextKey)("OpenTelemetry Baggage Key");function x(e){return e.getValue(E)||void 0}function T(){return x(C.ContextAPI.getInstance().active())}function M(e,t){return e.setValue(E,t)}function I(e){return e.deleteValue(E)}var B=e.i(119468),U=e.i(883153),L=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,o=n.call(e),r=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(s)throw s.error}}return r},H=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},A=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=L(e,2);return[t[0],t[1]]})},e.prototype.setEntry=function(t,n){var i=new e(this._entries);return i._entries.set(t,n),i},e.prototype.removeEntry=function(t){var n=new e(this._entries);return n._entries.delete(t),n},e.prototype.removeEntries=function(){for(var t,n,i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];var o=new e(this._entries);try{for(var r=H(i),a=r.next();!a.done;a=r.next()){var c=a.value;o._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return o},e.prototype.clear=function(){return new e},e}(),R=Symbol("BaggageEntryMetadata"),N=U.DiagAPI.instance();function O(e){return void 0===e&&(e={}),new A(new Map(Object.entries(e)))}function D(e){return"string"!=typeof e&&(N.error("Cannot create baggage metadata from unknown type: "+(void 0===e?"undefined":(0,B._)(e))),e=""),{__TYPE__:R,toString:function(){return e}}}e.s(["baggageEntryMetadataFromString",()=>D,"createBaggage",()=>O],472278);var q="propagation",F=new S,P=(function(){function e(){this.createBaggage=O,this.getBaggage=x,this.getActiveBaggage=T,this.setBaggage=M,this.deleteBaggage=I}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return(0,k.registerGlobal)(q,e,U.DiagAPI.instance())},e.prototype.inject=function(e,t,n){return void 0===n&&(n=b),this._getGlobalPropagator().inject(e,t,n)},e.prototype.extract=function(e,t,n){return void 0===n&&(n=w),this._getGlobalPropagator().extract(e,t,n)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){(0,k.unregisterGlobal)(q,U.DiagAPI.instance())},e.prototype._getGlobalPropagator=function(){return(0,k.getGlobal)(q)||F},e})().getInstance();e.s(["propagation",()=>P],364520);var V=e.i(468930),j=e.i(862927),z="UNCAUGHT_ERROR",K="UNEXPECTED_DISCONNECT",W="INVALID_REQUEST",G="CANCEL",J=function(e){return g.Type.Object({ok:g.Type.Literal(!1),payload:e})},$=g.Type.Object({path:g.Type.String(),message:g.Type.String()});function Q(e){var t=[],n=!0,i=!1,s=void 0;try{for(var o,r=e[Symbol.iterator]();!(n=(o=r.next()).done);n=!0){var a=o.value;t.push({path:a.path,message:a.message})}}catch(e){i=!0,s=e}finally{try{n||null==r.return||r.return()}finally{if(i)throw s}}return t}g.Type.Array($);var X=g.Type.Object({code:g.Type.Literal(G),message:g.Type.String()}),Y=J(X),Z=g.Type.Union([g.Type.Object({code:g.Type.Literal(z),message:g.Type.String()}),g.Type.Object({code:g.Type.Literal(K),message:g.Type.String()}),g.Type.Object({code:g.Type.Literal(W),message:g.Type.String(),extras:g.Type.Optional(g.Type.Object({firstValidationErrors:g.Type.Array($),totalErrors:g.Type.Number()}))}),X]),ee=J(Z);function et(e){return"Union"===e[v.Kind]}function en(e){return JSON.parse(JSON.stringify(e))}function ei(e){return"responseError"in e&&"Never"!==e.responseError[v.Kind]?en(function(e){if(!et(e))return e;var t=[];return!function e(n){if(et(n)){var i=!0,s=!1,o=void 0;try{for(var r,a=n.anyOf[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;e(c)}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}}else t.push(n)}(e),g.Type.Union(t)}(g.Type.Union([e.responseError,Z]))):en(Z)}var es=function(){function e(t){(0,o._)(this,e),(0,a._)(this,"config",void 0),this.config=t}return(0,r._)(e,[{key:"procedures",value:function(e){return e}},{key:"finalize",value:function(e){return(function(){function e(t,n){(0,o._)(this,e),(0,a._)(this,"initializeState",void 0),(0,a._)(this,"procedures",void 0),this.initializeState=t.initializeState,this.procedures=n}return(0,r._)(e,[{key:"serialize",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,d._)(e,2),n=t[0],i=t[1];return[n,(0,l._)((0,u._)((0,l._)({init:en(i.requestInit),output:en(i.responseData),errors:ei(i)},"description"in i?{description:i.description}:{}),{type:i.type}),"requestData"in i?{input:en(i.requestData)}:{})]}))}}},{key:"serializeV1Compat",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,d._)(e,2),n=t[0],i=t[1];return"rpc"===i.type||"subscription"===i.type?[n,(0,u._)((0,l._)({input:en(i.requestInit),output:en(i.responseData),errors:ei(i)},"description"in i?{description:i.description}:{}),{type:i.type})]:[n,(0,u._)((0,l._)({init:en(i.requestInit),output:en(i.responseData),errors:ei(i)},"description"in i?{description:i.description}:{}),{type:i.type,input:en(i.requestData)})]}))}}},{key:"instantiate",value:function(e){var t=this.initializeState(e);return Object.freeze((0,a._)({state:t,procedures:this.procedures},Symbol.asyncDispose,function(){return(0,s._)(function(){var e,n;return(0,f._)(this,function(i){switch(i.label){case 0:return[4,null==(e=t[Symbol.asyncDispose])?void 0:e.call(t)];case 1:return i.sent(),null==(n=t[Symbol.dispose])||n.call(t),[2]}})})()}))}}],[{key:"scaffold",value:function(e){return new es(e)}},{key:"define",value:function(t,n){var i,s;if("initializeState"in t&&"function"==typeof t.initializeState){if(!n)throw Error("Expected procedures to be defined");i=t,s=n}else i={initializeState:function(){return{}}},s=t;return new e(i,s)}}]),e})().define(this.config,e)}}]),e}(),eo=g.Type.Union([g.Type.Object({ok:g.Type.Literal(!1),payload:g.Type.Object({code:g.Type.String(),message:g.Type.String(),extras:g.Type.Optional(g.Type.Unknown())})}),g.Type.Object({ok:g.Type.Literal(!0),payload:g.Type.Unknown()})]);function er(e){return{ok:!0,payload:e}}function ea(e){return{ok:!1,payload:e}}var ec={code:"READABLE_BROKEN",message:"Readable was broken before it is fully consumed"},el=function(){function e(){(0,o._)(this,e),(0,a._)(this,"closed",!1),(0,a._)(this,"locked",!1),(0,a._)(this,"broken",!1),(0,a._)(this,"brokenWithValuesLeftToRead",!1),(0,a._)(this,"queue",[]),(0,a._)(this,"next",null)}return(0,r._)(e,[{key:Symbol.asyncIterator,value:function(){var e=this;if(this.locked)throw TypeError("Readable is already locked");this.locked=!0;var t=!1;return{next:function(){return(0,s._)(function(){return(0,f._)(this,function(e){switch(e.label){case 0:if(t)return[2,{done:!0,value:void 0}];e.label=1;case 1:var n,i;if(0!==this.queue.length)return[3,3];if(this.closed&&!this.brokenWithValuesLeftToRead)return[2,{done:!0,value:void 0}];if(this.broken)return t=!0,[2,{done:!1,value:ea(ec)}];return this.next||(this.next={promise:new Promise(function(e,t){n=e,i=t}),resolve:n,reject:i}),[4,this.next.promise];case 2:return e.sent(),this.next=null,[3,1];case 3:return[2,{done:!1,value:this.queue.shift()}]}})}).call(e)},return:function(){return(0,s._)(function(){return(0,f._)(this,function(e){return this.break(),[2,{done:!0,value:void 0}]})}).call(e)}}}},{key:"collect",value:function(){return(0,s._)(function(){var e,t,n,s,o,r,a,c;return(0,f._)(this,function(l){switch(l.label){case 0:e=[],t=!1,n=!1,l.label=1;case 1:l.trys.push([1,6,7,12]),o=(0,i._)(this),l.label=2;case 2:return[4,o.next()];case 3:if(!(t=!(r=l.sent()).done))return[3,5];a=r.value,e.push(a),l.label=4;case 4:return t=!1,[3,2];case 5:return[3,12];case 6:return c=l.sent(),n=!0,s=c,[3,12];case 7:if(l.trys.push([7,,10,11]),!(t&&null!=o.return))return[3,9];return[4,o.return()];case 8:l.sent(),l.label=9;case 9:return[3,11];case 10:if(n)throw s;return[7];case 11:return[7];case 12:return[2,e]}})}).call(this)}},{key:"break",value:function(){var e;this.broken||(this.locked=!0,this.broken=!0,this.brokenWithValuesLeftToRead=this.queue.length>0,this.queue.length=0,null==(e=this.next)||e.resolve())}},{key:"isReadable",value:function(){return!this.locked&&!this.broken}},{key:"_pushValue",value:function(e){var t;if(!this.broken){if(this.closed)throw Error("Cannot push to closed Readable");this.queue.push(e),null==(t=this.next)||t.resolve()}}},{key:"_triggerClose",value:function(){var e;if(this.closed)throw Error("Unexpected closing multiple times");this.closed=!0,null==(e=this.next)||e.resolve()}},{key:"_hasValuesInQueue",value:function(){return this.queue.length>0}},{key:"isClosed",value:function(){return this.closed}}]),e}(),eu=function(){function e(t){(0,o._)(this,e),(0,a._)(this,"writeCb",void 0),(0,a._)(this,"closeCb",void 0),(0,a._)(this,"closed",!1),this.writeCb=t.writeCb,this.closeCb=t.closeCb}return(0,r._)(e,[{key:"write",value:function(e){if(this.closed)throw Error("Cannot write to closed Writable");this.writeCb(e)}},{key:"isWritable",value:function(){return!this.closed}},{key:"close",value:function(e){this.closed||(void 0!==e&&this.writeCb(e),this.closed=!0,this.writeCb=function(){},this.closeCb(),this.closeCb=function(){})}},{key:"isClosed",value:function(){return this.closed}}]),e}(),ed=(0,p.customAlphabet)("1234567890abcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVXYZ"),eh=function(){return ed(12)},ef=g.Type.Object({type:g.Type.Literal("ACK")}),eg=g.Type.Object({type:g.Type.Literal("CLOSE")}),ev="v2.0",ep=["v1.1",ev];function ey(e){return ep.includes(e)}var em=g.Type.Object({type:g.Type.Literal("HANDSHAKE_REQ"),protocolVersion:g.Type.String(),sessionId:g.Type.String(),expectedSessionState:g.Type.Object({nextExpectedSeq:g.Type.Integer(),nextSentSeq:g.Type.Integer()}),metadata:g.Type.Optional(g.Type.Unknown())}),e_=g.Type.Union([g.Type.Literal("SESSION_STATE_MISMATCH")]),ek=g.Type.Union([g.Type.Literal("REJECTED_UNSUPPORTED_CLIENT"),g.Type.Literal("REJECTED_BY_CUSTOM_HANDLER")]),eS=g.Type.Union([ek,g.Type.Literal("MALFORMED_HANDSHAKE_META"),g.Type.Literal("MALFORMED_HANDSHAKE"),g.Type.Literal("PROTOCOL_VERSION_MISMATCH")]),ew=g.Type.Union([e_,eS]),eb=g.Type.Object({type:g.Type.Literal("HANDSHAKE_RESP"),status:g.Type.Union([g.Type.Object({ok:g.Type.Literal(!0),sessionId:g.Type.String()}),g.Type.Object({ok:g.Type.Literal(!1),reason:g.Type.String(),code:ew})])}),eC=g.Type.Union([eg,ef,em,eb]),eE=(t=g.Type.Unknown(),g.Type.Object({id:g.Type.String(),from:g.Type.String(),to:g.Type.String(),seq:g.Type.Integer(),ack:g.Type.Integer(),serviceName:g.Type.Optional(g.Type.String()),procedureName:g.Type.Optional(g.Type.String()),streamId:g.Type.String(),controlFlags:g.Type.Integer(),tracing:g.Type.Optional(g.Type.Object({traceparent:g.Type.String(),tracestate:g.Type.String()})),payload:t}));function ex(e){var t=e.from,n=e.to,i=e.sessionId,s=e.expectedSessionState,o=e.metadata,r=e.tracing;return{id:eh(),from:t,to:n,seq:0,ack:0,streamId:eh(),controlFlags:0,tracing:r,payload:{type:"HANDSHAKE_REQ",protocolVersion:ev,sessionId:i,expectedSessionState:s,metadata:o}}}function eT(e){var t=e.from,n=e.to,i=e.status;return{id:eh(),from:t,to:n,seq:0,ack:0,streamId:eh(),controlFlags:0,payload:{type:"HANDSHAKE_RESP",status:i}}}function eM(e){return{streamId:e,controlFlags:8,payload:{type:"CLOSE"}}}function eI(e,t){return{streamId:e,controlFlags:4,payload:t}}function eB(e){return(1&e)==1}function eU(e){var t={traceparent:"",tracestate:""};return P.inject(e,t),t}function eL(e,t,n,i,s){var o=s?P.extract(_.context.active(),s):_.context.active(),r=e.startSpan("river.session",{attributes:{component:"river","river.session.id":t,"river.session.to":n,"river.session.from":i}},o),a=V.trace.setSpan(o,r);return{span:r,ctx:a}}function eH(e,t,n){var i=e.startSpan("river.connection",{attributes:{component:"river","river.connection.id":t.id},links:[{context:n.span.spanContext()}]},n.ctx),s=V.trace.setSpan(n.ctx,i);return{span:i,ctx:s}}function eA(e,t){e.setStatus({code:m.SpanStatusCode.ERROR,message:t.message}),e.setAttributes({"river.error_code":t.code,"river.error_message":t.message})}function eR(){return V.trace.getTracer("river",eW)}var eN=function(){},eO={connectOnInvoke:!0,eagerlyConnect:!0};function eD(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.handshakeOptions&&e.extendHandshake(n.handshakeOptions);var i=(0,l._)({},eO,n);return i.eagerlyConnect&&e.connect(t),function e(t,n){return new Proxy(eN,{get:function(i,s){if("string"==typeof s)return e(t,(0,h._)(n).concat([s]))},apply:function(e,i,s){return t({path:n,args:s})}})}(function(n){var s=(0,d._)((0,h._)(n.path),3),o=s[0],r=s[1],a=s[2];if(!(o&&r&&a))throw Error("invalid river call, ensure the service and procedure you are calling exists");var c=(0,d._)(n.args,2),f=c[0],g=c[1];if(i.connectOnInvoke&&!e.sessions.has(t)&&e.connect(t),"rpc"!==a&&"subscribe"!==a&&"stream"!==a&&"upload"!==a)throw Error("invalid river call, unknown procedure type ".concat(a));return function(e,t,n,i,s,o,r){if("closed"===t.getStatus()){var a,c,d,f;return a=e,c=new el,d=ea({code:K,message:"transport is closed"}),c._pushValue(d),c._triggerClose(),(f=new eu({writeCb:function(){},closeCb:function(){}})).close(),eq(a,c,f)}var g,v,p,m,k,S,w,b=null!=(w=t.sessions.get(n))?w:t.createUnconnectedSession(n),C=t.getSessionBoundSendFn(n,b.id),E="rpc"===e||"subscription"===e,x=eh(),T=(g=t.tracer,p=_.context.active(),m=g.startSpan("river.client.".concat(s,".").concat(o),{attributes:{component:"river","river.method.kind":e,"river.method.service":s,"river.method.name":o,"river.streamId":x,"span.kind":"client"},links:[{context:b.telemetry.span.spanContext()}],kind:y.SpanKind.CLIENT},p),k=V.trace.setSpan(p,m),S=(0,u._)((0,l._)({},b.loggingMetadata),{transportMessage:{procedureName:o,serviceName:s}}),m.isRecording()&&(S.telemetry={traceId:m.spanContext().traceId,spanId:m.spanContext().spanId}),null==(v=b.log)||v.info("invoked ".concat(s,".").concat(o),S),{span:m,ctx:k}),M=T.span,I=T.ctx,B=!0,U=new eu({writeCb:function(e){C({streamId:x,payload:e,controlFlags:0})},closeCb:function(){M.addEvent("reqWritable closed"),!E&&B&&C(eM(x)),L.isClosed()&&A()}}),L=new el,H=function(){L._triggerClose(),M.addEvent("resReadable closed"),U.isClosed()&&A()};function A(){t.removeEventListener("message",N),t.removeEventListener("sessionStatus",O),null==r||r.removeEventListener("abort",R),M.end()}function R(){L.isClosed()&&U.isClosed()||(M.addEvent("sending cancel"),B=!1,L.isClosed()||(L._pushValue(ea({code:G,message:"cancelled by client"})),H()),U.close(),C(eI(x,ea({code:G,message:"cancelled by client"}))))}function N(e){var n,i,s,o,r,a;if(e.streamId===x){if(e.to!==t.clientId){null==(n=t.log)||n.error("got stream message from unexpected client",{clientId:t.clientId,transportMessage:e});return}if((4&e.controlFlags)==4){B=!1,M.addEvent("received cancel"),j.Value.Check(ee,e.payload)?i=e.payload:(i=ea({code:G,message:"stream cancelled with invalid payload"}),null==(s=t.log)||s.warn("got stream cancel without a valid protocol error",{clientId:t.clientId,transportMessage:e,validationErrors:(0,h._)(j.Value.Errors(ee,e.payload))})),L.isClosed()||(L._pushValue(i),H()),U.close();return}if(L.isClosed()){M.recordException("received message after response stream is closed"),null==(o=t.log)||o.error("received message after response stream is closed",{clientId:t.clientId,transportMessage:e});return}j.Value.Check(eg,e.payload)||(j.Value.Check(eo,e.payload)?L._pushValue(e.payload):null==(r=t.log)||r.error("Got non-control payload, but was not a valid result",{clientId:t.clientId,transportMessage:e,validationErrors:(0,h._)(j.Value.Errors(eo,e.payload))})),(8&e.controlFlags)==8&&(M.addEvent("received response close"),L.isClosed()?null==(a=t.log)||a.error("received stream close but readable was already closed"):H())}}function O(e){"closing"===e.status&&e.session.to===n&&b.id===e.session.id&&(B=!1,L.isClosed()||(L._pushValue(ea({code:K,message:"".concat(n," unexpectedly disconnected")})),H()),U.close())}return null==r||r.addEventListener("abort",R),t.addEventListener("message",N),t.addEventListener("sessionStatus",O),C({streamId:x,serviceName:s,procedureName:o,tracing:eU(I),payload:i,controlFlags:E?10:2}),E&&U.close(),eq(e,L,U,t.log)}("subscribe"===a?"subscription":a,e,t,f,o,r,g?g.signal:void 0)},[])}function eq(e,t,n,i){if("subscription"===e)return{resReadable:t};if("rpc"===e)return eF(t,i);if("upload"===e){var s=!1;return{reqWritable:n,finalize:function(){if(s)throw Error("upload stream already finalized");return s=!0,n.isClosed()||n.close(),eF(t,i)}}}return{resReadable:t,reqWritable:n}}function eF(e,t){return(0,s._)(function(){var n;return(0,f._)(this,function(i){switch(i.label){case 0:return[4,e.collect()];case 1:return(n=i.sent()).length>1&&(null==t||t.error("Expected single message from server, got multiple")),[2,n[0]]}})})()}function eP(e){return(0,c._)(e,Error)?e.message||"unknown reason":"[coerced to error] ".concat(String(e))}(0,r._)(function e(t,n,i,s){var r=this,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:200,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];(0,o._)(this,e),(0,a._)(this,"transport",void 0),(0,a._)(this,"contextMap",void 0),(0,a._)(this,"log",void 0),(0,a._)(this,"middlewares",void 0),(0,a._)(this,"serverCancelledStreams",void 0),(0,a._)(this,"maxCancelledStreamTombstonesPerSession",void 0),(0,a._)(this,"streams",void 0),(0,a._)(this,"services",void 0),(0,a._)(this,"unregisterTransportListeners",void 0);var f={};this.middlewares=h,this.services=f,this.contextMap=new Map,s=null!=s?s:{};var g=!0,v=!1,p=void 0;try{for(var m,k=Object.entries(n)[Symbol.iterator]();!(g=(m=k.next()).done);g=!0){var S=(0,d._)(m.value,2),w=S[0],b=S[1].instantiate(s);f[w]=b,this.contextMap.set(b,(0,u._)((0,l._)({},s),{state:b.state}))}}catch(e){v=!0,p=e}finally{try{g||null==k.return||k.return()}finally{if(v)throw p}}i&&t.extendHandshake(i),this.transport=t,this.streams=new Map,this.serverCancelledStreams=new Map,this.maxCancelledStreamTombstonesPerSession=c,this.log=t.log;var C=function(e){if(e.to!==r.transport.clientId){null==(h=r.log)||h.info("got msg with destination that isn't this server, ignoring",{clientId:r.transport.clientId,transportMessage:e});return}var n,i,s,o,a,c,l,u,d,h,f=e.streamId,g=r.streams.get(f);if(g)return void g.handleMsg(e);if(null==(d=r.serverCancelledStreams.get(e.from))||!d.has(f)){var v=r.validateNewProcStream(e);v&&(n=t.tracer,i=v.initialSession,s=v.procedure.type,o=v.serviceName,a=v.procedureName,c=v.streamId,l=v.tracingCtx,u=l?P.extract(_.context.active(),l):_.context.active(),n.startActiveSpan("river.server.".concat(o,".").concat(a),{attributes:{component:"river","river.method.kind":s,"river.method.service":o,"river.method.name":a,"river.streamId":c,"span.kind":"server"},links:[{context:i.telemetry.span.spanContext()}],kind:y.SpanKind.SERVER},u,function(e){r.createNewProcStream(e,v)}))}},E=function(e){if("closing"===e.status){var t=e.session.to;null==(o=r.log)||o.info("got session disconnect from ".concat(t,", cleaning up streams"),e.session.loggingMetadata);var n=!0,i=!1,s=void 0;try{for(var o,a,c=r.streams.values()[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value;l.from===t&&l.handleSessionDisconnect()}}catch(e){i=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw s}}r.serverCancelledStreams.delete(t)}},x=function(e){"closed"===e.status&&r.unregisterTransportListeners()};this.unregisterTransportListeners=function(){r.transport.removeEventListener("message",C),r.transport.removeEventListener("sessionStatus",E),r.transport.removeEventListener("transportStatus",x)},this.transport.addEventListener("message",C),this.transport.addEventListener("sessionStatus",E),this.transport.addEventListener("transportStatus",x)},[{key:"createNewProcStream",value:function(e,t){var n=this,i=t.streamId,o=t.initialSession,r=t.procedureName,a=t.serviceName,d=t.procedure,g=t.sessionMetadata,v=t.serviceContext,p=t.initPayload,y=t.procClosesWithInit,m=t.passInitAsDataForBackwardsCompat,_=o.to,k=o.loggingMetadata,S=o.protocolVersion,w=o.id;k.telemetry={traceId:e.spanContext().traceId,spanId:e.spanContext().spanId};var b=!0,C=new AbortController,E=this.transport.getSessionBoundSendFn(_,w),x=function(e,t){n.cancelStream(_,E,e,t)},T=function(t){if(eA(e,t),!(B.isClosed()&&L.isClosed())){b=!1;var n=ea(t);B.isClosed()||(B._pushValue(n),U()),L.close(),x(i,n)}},M=function(){C.abort(),n.streams.delete(i)},I="rpc"===d.type||"upload"===d.type,B=new el,U=function(){B._triggerClose(),"v1.1"!==S||I||L.isClosed()||L.close(),L.isClosed()&&M()};m&&B._pushValue(er(p));var L=new eu({writeCb:function(t){t.ok||eA(e,t.payload),E({streamId:i,controlFlags:I?ez(S):0,payload:t}),I&&L.close()},closeCb:function(){if(!I&&b){var e=eM(i);e.controlFlags=ez(S),E(e)}"v1.1"!==S||B.isClosed()||U(),B.isClosed()&&M()}}),H=function(e,t){var i,s=eP(e);t.recordException((0,c._)(e,Error)?e:Error(s)),null==(i=n.log)||i.error("".concat(a,".").concat(r," handler threw an uncaught error"),(0,u._)((0,l._)({},k),{transportMessage:{procedureName:r,serviceName:a},extras:{error:s,originalException:e},tags:["uncaught-handler-error"]})),T({code:z,message:s})};y&&U();var A=(0,u._)((0,l._)({},v),{from:_,sessionId:w,metadata:g,span:e,cancel:function(e){var t={code:G,message:null!=e?e:"cancelled by server procedure handler"};return T(t),ea(t)},signal:C.signal}),R=(0,u._)((0,l._)({},v),{sessionId:w,from:_,metadata:g,span:e,signal:C.signal,streamId:i,procedureName:r,serviceName:a});this.middlewares.reduceRight(function(e,t){return function(){t({ctx:R,reqInit:p,next:e})}},function(){(0,s._)(function(){var t,n;return(0,f._)(this,function(i){switch(i.label){case 0:switch(d.type){case"rpc":return[3,1];case"stream":return[3,6];case"subscription":return[3,11];case"upload":return[3,16]}return[3,21];case 1:return i.trys.push([1,3,4,5]),[4,d.handler({ctx:A,reqInit:p})];case 2:if(t=i.sent(),L.isClosed())return[2];return L.write(t),[3,5];case 3:return H(i.sent(),e),[3,5];case 4:case 9:case 14:case 19:return e.end(),[7];case 5:case 10:case 15:case 20:return[3,21];case 6:return i.trys.push([6,8,9,10]),[4,d.handler({ctx:A,reqInit:p,reqReadable:B,resWritable:L})];case 7:return i.sent(),[3,10];case 8:return H(i.sent(),e),[3,10];case 11:return i.trys.push([11,13,14,15]),[4,d.handler({ctx:A,reqInit:p,resWritable:L})];case 12:return i.sent(),[3,15];case 13:return H(i.sent(),e),[3,15];case 16:return i.trys.push([16,18,19,20]),[4,d.handler({ctx:A,reqInit:p,reqReadable:B})];case 17:if(n=i.sent(),L.isClosed())return[2];return L.write(n),[3,20];case 18:return H(i.sent(),e),[3,20];case 21:return[2]}})})()})(),C.signal.aborted||this.streams.set(i,{from:_,streamId:i,procedureName:r,serviceName:a,sessionMetadata:g,procedure:d,handleMsg:function(e){var t,i,s,o,r,a,c,f;if(e.from!==_){null==(i=n.log)||i.error("got stream message from unexpected client",(0,u._)((0,l._)({},k),{transportMessage:e,tags:["invariant-violation"]}));return}if(f=e.controlFlags,"v1.1"!==S&&(4&f)==4){j.Value.Check(Y,e.payload)?s=e.payload:(s=ea({code:G,message:"stream cancelled, client sent invalid payload"}),null==(o=n.log)||o.warn("got stream cancel without a valid protocol error",(0,u._)((0,l._)({},k),{transportMessage:e,validationErrors:(0,h._)(j.Value.Errors(Y,e.payload)),tags:["invalid-request"]}))),B.isClosed()||(B._pushValue(s),U()),L.close();return}if(B.isClosed()){null==(r=n.log)||r.warn("received message after request stream is closed",(0,u._)((0,l._)({},k),{transportMessage:e,tags:["invalid-request"]})),T({code:W,message:"received message after request stream is closed"});return}if("requestData"in d&&j.Value.Check(d.requestData,e.payload)){B._pushValue(er(e.payload)),ej(e.controlFlags,S)&&U();return}j.Value.Check(eC,e.payload)&&ej(e.controlFlags,S)?U():("requestData"in d?(c="message in requestData position did not match schema",a=Q(j.Value.Errors(d.requestData,e.payload))):(a=Q(j.Value.Errors(eC,e.payload)),c="message in control payload position did not match schema"),null==(t=n.log)||t.warn(c,(0,u._)((0,l._)({},k),{transportMessage:e,validationErrors:a.map(function(e){return{path:e.path,message:e.message}}),tags:["invalid-request"]})),T({code:W,message:c,extras:{totalErrors:a.length,firstValidationErrors:a.slice(0,5)}}))},handleSessionDisconnect:function(){b=!1,B.isClosed()||(B._pushValue(ea({code:K,message:"client unexpectedly disconnected"})),U()),L.close()}})}},{key:"getContext",value:function(e,t){var n=this.contextMap.get(e);if(!n){var i,s="no context found for ".concat(t);throw null==(i=this.log)||i.error(s,{clientId:this.transport.clientId,tags:["invariant-violation"]}),Error(s)}return n}},{key:"validateNewProcStream",value:function(e){var t=this,n=this.transport.sessions.get(e.from);if(!n)return null==(r=this.log)||r.error("couldn't find session for ".concat(e.from),{clientId:this.transport.clientId,transportMessage:e,tags:["invariant-violation"]}),null;var i=this.transport.getSessionBoundSendFn(e.from,n.id),s=function(n,s){t.cancelStream(e.from,i,n,s)},o=this.transport.sessionHandshakeMetadata.get(n.to);if(!o){var r,a,c="session doesn't have handshake metadata";return null==(a=this.log)||a.error(c,(0,u._)((0,l._)({},n.loggingMetadata),{tags:["invariant-violation"]})),s(e.streamId,ea({code:z,message:c})),null}if((2&e.controlFlags)!=2){var d,h="can't create a new procedure stream from a message that doesn't have the stream open bit set";return null==(d=this.log)||d.warn(h,(0,u._)((0,l._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:h})),null}if(!e.serviceName){var f,g="missing service name in stream open message";return null==(f=this.log)||f.warn(g,(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:g})),null}if(!e.procedureName){var v,p="missing procedure name in stream open message";return null==(v=this.log)||v.warn(p,(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:p})),null}if(!(e.serviceName in this.services)){var y,m="couldn't find service ".concat(e.serviceName);return null==(y=this.log)||y.warn(m,(0,u._)((0,l._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:m})),null}var _=this.services[e.serviceName];if(!(e.procedureName in _.procedures)){var k,S="couldn't find a matching procedure for ".concat(e.serviceName,".").concat(e.procedureName);return null==(k=this.log)||k.warn(S,(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:S})),null}var w=this.getContext(_,e.serviceName),b=_.procedures[e.procedureName];if(!["rpc","upload","stream","subscription"].includes(b.type))return null==(E=this.log)||E.error("got request for invalid procedure type ".concat(b.type," at ").concat(e.serviceName,".").concat(e.procedureName),(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),null;var C=!1;if("v1.1"===n.protocolVersion&&("upload"===b.type||"stream"===b.type)&&j.Value.Check(b.requestData,e.payload)&&j.Value.Check(b.requestInit,{}))C=!0;else if(!j.Value.Check(b.requestInit,e.payload)){var E,x,T="procedure init failed validation";return null==(x=this.log)||x.warn(T,(0,u._)((0,l._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,ea({code:W,message:T})),null}return{initialSession:n,streamId:e.streamId,procedureName:e.procedureName,serviceName:e.serviceName,tracingCtx:e.tracing,initPayload:e.payload,sessionMetadata:o,procedure:b,serviceContext:w,procClosesWithInit:ej(e.controlFlags,n.protocolVersion),passInitAsDataForBackwardsCompat:C}}},{key:"cancelStream",value:function(e,t,n,i){var s=this.serverCancelledStreams.get(e);s||(s=new eV(this.maxCancelledStreamTombstonesPerSession),this.serverCancelledStreams.set(e,s)),s.add(n),t(eI(n,i))}},{key:"close",value:function(){return(0,s._)(function(){var e,t,n,i,s,o,r;return(0,f._)(this,function(a){switch(a.label){case 0:this.unregisterTransportListeners(),e=!0,t=!1,n=void 0,a.label=1;case 1:a.trys.push([1,6,7,8]),i=Object.keys(this.services)[Symbol.iterator](),a.label=2;case 2:if(e=(s=i.next()).done)return[3,5];return o=s.value,[4,this.services[o][Symbol.asyncDispose]()];case 3:a.sent(),a.label=4;case 4:return e=!0,[3,2];case 5:return[3,8];case 6:return r=a.sent(),t=!0,n=r,[3,8];case 7:try{e||null==i.return||i.return()}finally{if(t)throw n}return[7];case 8:return[2]}})}).call(this)}}]);var eV=function(){function e(t){(0,o._)(this,e),(0,a._)(this,"items",void 0),(0,a._)(this,"maxItems",void 0),this.items=new Set,this.maxItems=t}return(0,r._)(e,[{key:"add",value:function(e){if(this.items.has(e))this.items.delete(e);else if(this.items.size>=this.maxItems){var t=this.items.values().next();t.done||this.items.delete(t.value)}this.items.add(e)}},{key:"has",value:function(e){return this.items.has(e)}}]),e}();function ej(e,t){return"v1.1"===t?(4&e)==4:(8&e)==8}function ez(e){return"v1.1"===e?4:8}function eK(e,t){return{schema:e,construct:t}}var eW="0.212.1";e.s(["ControlMessageHandshakeRequestSchema",()=>em,"ControlMessageHandshakeResponseSchema",()=>eb,"Err",()=>ea,"HandshakeErrorCustomHandlerFatalResponseCodes",()=>ek,"HandshakeErrorRetriableResponseCodes",()=>e_,"Ok",()=>er,"OpaqueTransportMessageSchema",()=>eE,"acceptedProtocolVersions",()=>ep,"coerceErrorString",()=>eP,"createClient",()=>eD,"createClientHandshakeOptions",()=>eK,"createConnectionTelemetryInfo",()=>eH,"createSessionTelemetryInfo",()=>eL,"currentProtocolVersion",()=>ev,"generateId",()=>eh,"getPropagationContext",()=>eU,"getTracer",()=>eR,"handshakeRequestMessage",()=>ex,"handshakeResponseMessage",()=>eT,"isAcceptedProtocolVersion",()=>ey,"isAck",()=>eB,"version",()=>eW],792129),e.s(["RIVER_VERSION",()=>eW],227062);var eG=e.i(399119),eJ=e.i(663355),e$=e.i(862470),eQ=e.i(445789),eX=e.i(463348),eY=e.i(886513),eZ={debug:-1,info:0,warn:1,error:2},e0=function(e){return function(t,n){if(n&&!n.telemetry){var i=V.trace.getSpan(_.context.active());i&&(n.telemetry={traceId:i.spanContext().traceId,spanId:i.spanContext().spanId})}if(!(null==n?void 0:n.transportMessage))return void e(t,n);var s=n.transportMessage;s.payload,n.transportMessage=(0,eY._)(s,["payload"]),e(t,n)}},e1=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";(0,o._)(this,e),(0,a._)(this,"minLevel",void 0),(0,a._)(this,"output",void 0),this.minLevel=n,this.output=t}return(0,r._)(e,[{key:"debug",value:function(e,t){eZ[this.minLevel]<=eZ.debug&&this.output(e,null!=t?t:{},"debug")}},{key:"info",value:function(e,t){eZ[this.minLevel]<=eZ.info&&this.output(e,null!=t?t:{},"info")}},{key:"warn",value:function(e,t){eZ[this.minLevel]<=eZ.warn&&this.output(e,null!=t?t:{},"warn")}},{key:"error",value:function(e,t){eZ[this.minLevel]<=eZ.error&&this.output(e,null!=t?t:{},"error")}}]),e}(),e2=function(e){return{debug:e0(e.debug.bind(e)),info:e0(e.info.bind(e)),warn:e0(e.warn.bind(e)),error:e0(e.error.bind(e))}},e3=function(e){function t(e){(0,o._)(this,t);var n=(0,eG._)(this,t,[e]);return Object.setPrototypeOf(n,Object.create(t.prototype)),Object.defineProperty(n,"name",{configurable:!0,enumerable:!1,value:t.name}),n}return(0,eQ._)(t,e),t}((0,eX._)(Error)),e6=function e(t,n){(0,o._)(this,e),this.type=t,this.data=n};function e4(e,t,n){var i=Math.floor(n/0x100000000);e.setUint32(t,i),e.setUint32(t+4,n)}function e8(e,t){return 0x100000000*e.getInt32(t)+e.getUint32(t+4)}var e5={type:-1,encode:function(e){var t,n,i,s;return(0,c._)(e,Date)?function(e){var t=e.sec,n=e.nsec;if(t>=0&&n>=0&&t<=0x3ffffffff)if(0===n&&t<=0xffffffff){var i=new Uint8Array(4);return new DataView(i.buffer).setUint32(0,t),i}else{var s=t/0x100000000,o=new Uint8Array(8),r=new DataView(o.buffer);return r.setUint32(0,n<<2|3&s),r.setUint32(4,0|t),o}var a=new Uint8Array(12),c=new DataView(a.buffer);return c.setUint32(0,n),e4(c,4,t),a}((n=Math.floor((t=e.getTime())/1e3),s=Math.floor((i=(t-1e3*n)*1e6)/1e9),{sec:n+s,nsec:i-1e9*s})):null},decode:function(e){var t=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:(3&n)*0x100000000+t.getUint32(4),nsec:n>>>2};case 12:return{sec:e8(t,4),nsec:t.getUint32(0)};default:throw new e3("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}},e9=function(){function e(){(0,o._)(this,e),this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(e5)}return(0,r._)(e,[{key:"register",value:function(e){var t=e.type,n=e.encode,i=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=i;else{var s=-1-t;this.builtInEncoders[s]=n,this.builtInDecoders[s]=i}}},{key:"tryToEncode",value:function(e,t){for(var n=0;n<this.builtInEncoders.length;n++){var i=this.builtInEncoders[n];if(null!=i){var s=i(e,t);if(null!=s)return new e6(-1-n,s)}}for(var o=0;o<this.encoders.length;o++){var r=this.encoders[o];if(null!=r){var a=r(e,t);if(null!=a)return new e6(o,a)}}return(0,c._)(e,e6)?e:null}},{key:"decode",value:function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new e6(t,e)}}]),e}();e9.defaultCodec=new e9;var e7=e.i(693482),te=e.i(452723),tt=e.i(903673);function tn(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}var ti=new TextEncoder;function ts(e,t,n){for(var i,s=t,o=s+n,r=[],a="";s<o;){var c,l=e[s++];if((128&l)==0)r.push(l);else if((224&l)==192){var u=63&e[s++];r.push((31&l)<<6|u)}else if((240&l)==224){var d=63&e[s++],f=63&e[s++];r.push((31&l)<<12|d<<6|f)}else if((248&l)==240){var g=(7&l)<<18|(63&e[s++])<<12|(63&e[s++])<<6|63&e[s++];g>65535&&(g-=65536,r.push(g>>>10&1023|55296),g=56320|1023&g),r.push(g)}else r.push(l);r.length>=4096&&(a+=(c=String).fromCharCode.apply(c,(0,h._)(r)),r.length=0)}return r.length>0&&(a+=(i=String).fromCharCode.apply(i,(0,h._)(r))),a}var to=new TextDecoder;function tr(e){return(0,c._)(e,Uint8Array)?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):(0,c._)(e,ArrayBuffer)||"undefined"!=typeof SharedArrayBuffer&&(0,c._)(e,SharedArrayBuffer)?new Uint8Array(e):Uint8Array.from(e)}var ta=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16;(0,o._)(this,e),this.hit=0,this.miss=0,this.maxKeyLength=t,this.maxLengthPerKey=n,this.caches=[];for(var i=0;i<this.maxKeyLength;i++)this.caches.push([])}return(0,r._)(e,[{key:"canBeCached",value:function(e){return e>0&&e<=this.maxKeyLength}},{key:"find",value:function(e,t,n){var i=this.caches[n-1],s=!0,o=!1,r=void 0;try{e:for(var a,c=i[Symbol.iterator]();!(s=(a=c.next()).done);s=!0){for(var l=a.value,u=l.bytes,d=0;d<n;d++)if(u[d]!==e[t+d])continue e;return l.str}}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}return null}},{key:"store",value:function(e,t){var n=this.caches[e.length-1],i={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=i:n.push(i)}},{key:"decode",value:function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=ts(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s}}]),e}(),tc="array",tl="map_key",tu="map_value",td=function(e){if("string"==typeof e||"number"==typeof e)return e;throw new e3("The type of key must be string or number but "+(void 0===e?"undefined":(0,B._)(e)))},th=function(){function e(){(0,o._)(this,e),this.stack=[],this.stackHeadPosition=-1}return(0,r._)(e,[{key:"length",get:function(){return this.stackHeadPosition+1}},{key:"top",value:function(){return this.stack[this.stackHeadPosition]}},{key:"pushArrayState",value:function(e){var t=this.getUninitializedStateFromPool();t.type=tc,t.position=0,t.size=e,t.array=Array(e)}},{key:"pushMapState",value:function(e){var t=this.getUninitializedStateFromPool();t.type=tl,t.readCount=0,t.size=e,t.map={}}},{key:"getUninitializedStateFromPool",value:function(){return this.stackHeadPosition++,this.stackHeadPosition===this.stack.length&&this.stack.push({type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null}),this.stack[this.stackHeadPosition]}},{key:"release",value:function(e){if(this.stack[this.stackHeadPosition]!==e)throw Error("Invalid stack state. Released state is not on top of the stack.");e.type===tc&&(e.size=0,e.array=void 0,e.position=0,e.type=void 0),(e.type===tl||e.type===tu)&&(e.size=0,e.map=void 0,e.readCount=0,e.type=void 0),this.stackHeadPosition--}},{key:"reset",value:function(){this.stack.length=0,this.stackHeadPosition=-1}}]),e}(),tf=new DataView(new ArrayBuffer(0)),tg=new Uint8Array(tf.buffer);try{tf.getInt8(0)}catch(e){if(!(0,c._)(e,RangeError))throw Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var tv=RangeError("Insufficient data"),tp=new ta,ty=function(){function e(t){var n,i,s,r,a,c,l,u,d;(0,o._)(this,e),this.totalPos=0,this.pos=0,this.view=tf,this.bytes=tg,this.headByte=-1,this.stack=new th,this.entered=!1,this.extensionCodec=null!=(n=null==t?void 0:t.extensionCodec)?n:e9.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!=(i=null==t?void 0:t.useBigInt64)&&i,this.rawStrings=null!=(s=null==t?void 0:t.rawStrings)&&s,this.maxStrLength=null!=(r=null==t?void 0:t.maxStrLength)?r:0xffffffff,this.maxBinLength=null!=(a=null==t?void 0:t.maxBinLength)?a:0xffffffff,this.maxArrayLength=null!=(c=null==t?void 0:t.maxArrayLength)?c:0xffffffff,this.maxMapLength=null!=(l=null==t?void 0:t.maxMapLength)?l:0xffffffff,this.maxExtLength=null!=(u=null==t?void 0:t.maxExtLength)?u:0xffffffff,this.keyDecoder=(null==t?void 0:t.keyDecoder)!==void 0?t.keyDecoder:tp,this.mapKeyConverter=null!=(d=null==t?void 0:t.mapKeyConverter)?d:td}return(0,r._)(e,[{key:"clone",value:function(){return new e({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}},{key:"reinitializeState",value:function(){this.totalPos=0,this.headByte=-1,this.stack.reset()}},{key:"setBuffer",value:function(e){var t=tr(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}},{key:"appendBuffer",value:function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=tr(e),i=new Uint8Array(t.length+n.length);i.set(t),i.set(n,t.length),this.setBuffer(i)}else this.setBuffer(e)}},{key:"hasRemaining",value:function(e){return this.view.byteLength-this.pos>=e}},{key:"createExtraByteError",value:function(e){var t=this.view,n=this.pos;return RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))}},{key:"decode",value:function(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}},{key:"decodeMulti",value:function(e){var t;return(0,f._)(this,function(n){switch(n.label){case 0:if(!this.entered)return[3,2];return t=this.clone(),[5,(0,tt._)(t.decodeMulti(e))];case 1:return n.sent(),[2];case 2:n.trys.push([2,,6,7]),this.entered=!0,this.reinitializeState(),this.setBuffer(e),n.label=3;case 3:if(!this.hasRemaining(1))return[3,5];return[4,this.doDecodeSync()];case 4:return n.sent(),[3,3];case 5:return[3,7];case 6:return this.entered=!1,[7];case 7:return[2]}})}},{key:"decodeAsync",value:function(e){return(0,s._)(function(){var t,n,s,o,r,a,l,u,d,h,g,v,p;return(0,f._)(this,function(f){switch(f.label){case 0:if(this.entered)return[2,this.clone().decodeAsync(e)];f.label=1;case 1:f.trys.push([1,,14,15]),this.entered=!0,t=!1,s=!1,o=!1,f.label=2;case 2:f.trys.push([2,7,8,13]),a=(0,i._)(e),f.label=3;case 3:return[4,a.next()];case 4:if(!(s=!(l=f.sent()).done))return[3,6];if(u=l.value,t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(u);try{n=this.doDecodeSync(),t=!0}catch(e){if(!(0,c._)(e,RangeError))throw e}this.totalPos+=this.pos,f.label=5;case 5:return s=!1,[3,3];case 6:return[3,13];case 7:return d=f.sent(),o=!0,r=d,[3,13];case 8:if(f.trys.push([8,,11,12]),!(s&&null!=a.return))return[3,10];return[4,a.return()];case 9:f.sent(),f.label=10;case 10:return[3,12];case 11:if(o)throw r;return[7];case 12:return[7];case 13:if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,n]}throw h=this,g=h.headByte,v=h.pos,p=h.totalPos,RangeError("Insufficient data in parsing ".concat(tn(g)," at ").concat(p," (").concat(v," in the current buffer)"));case 14:return this.entered=!1,[7];case 15:return[2]}})}).call(this)}},{key:"decodeArrayStream",value:function(e){return this.decodeMultiAsync(e,!0)}},{key:"decodeStream",value:function(e){return this.decodeMultiAsync(e,!1)}},{key:"decodeMultiAsync",value:function(e,t){return(0,te._)(function(){var n,s,o,r,a,l,u,d,h,g,v;return(0,f._)(this,function(f){switch(f.label){case 0:if(!this.entered)return[3,2];return n=this.clone(),[5,(0,tt._)(function(e,t){var n={},i=!1;function s(t,n){return i=!0,{done:!1,value:(void 0)(n=new Promise(function(i){i(e[t](n))}))}}return"function"==typeof Symbol&&Symbol.iterator&&(n[Symbol.iterator]=function(){return this}),n.next=function(e){return i?(i=!1,e):s("next",e)},"function"==typeof e.throw&&(n.throw=function(e){if(i)throw i=!1,e;return s("throw",e)}),"function"==typeof e.return&&(n.return=function(e){return s("return",e)}),n}((0,i._)(n.decodeMultiAsync(e,t))))];case 1:return f.sent(),[2];case 2:f.trys.push([2,,21,22]),this.entered=!0,s=t,o=-1,r=!1,a=!1,f.label=3;case 3:f.trys.push([3,14,15,20]),u=(0,i._)(e),f.label=4;case 4:return[4,(0,e7._)(u.next())];case 5:if(!(r=!(d=f.sent()).done))return[3,13];if(h=d.value,t&&0===o)throw this.createExtraByteError(this.totalPos);this.appendBuffer(h),s&&(o=this.readArraySize(),s=!1,this.complete()),f.label=6;case 6:f.trys.push([6,10,,11]),f.label=7;case 7:return[4,this.doDecodeSync()];case 8:if(f.sent(),0==--o)return[3,9];return[3,7];case 9:return[3,11];case 10:if(g=f.sent(),!(0,c._)(g,RangeError))throw g;return[3,11];case 11:this.totalPos+=this.pos,f.label=12;case 12:return r=!1,[3,4];case 13:return[3,20];case 14:return v=f.sent(),a=!0,l=v,[3,20];case 15:if(f.trys.push([15,,18,19]),!(r&&null!=u.return))return[3,17];return[4,(0,e7._)(u.return())];case 16:f.sent(),f.label=17;case 17:return[3,19];case 18:if(a)throw l;return[7];case 19:return[7];case 20:return[3,22];case 21:return this.entered=!1,[7];case 22:return[2]}})}).call(this)}},{key:"doDecodeSync",value:function(){t:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){var n=e-128;if(0!==n){this.pushMapState(n),this.complete();continue}t={}}else if(e<160){var i=e-144;if(0!==i){this.pushArrayState(i),this.complete();continue}t=[]}else{var s=e-160;t=this.decodeString(s,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===e){var o=this.lookU8();t=this.decodeString(o,1)}else if(218===e){var r=this.lookU16();t=this.decodeString(r,2)}else if(219===e){var a=this.lookU32();t=this.decodeString(a,4)}else if(220===e){var c=this.readU16();if(0!==c){this.pushArrayState(c),this.complete();continue}t=[]}else if(221===e){var l=this.readU32();if(0!==l){this.pushArrayState(l),this.complete();continue}t=[]}else if(222===e){var u=this.readU16();if(0!==u){this.pushMapState(u),this.complete();continue}t={}}else if(223===e){var d=this.readU32();if(0!==d){this.pushMapState(d),this.complete();continue}t={}}else if(196===e){var h=this.lookU8();t=this.decodeBinary(h,1)}else if(197===e){var f=this.lookU16();t=this.decodeBinary(f,2)}else if(198===e){var g=this.lookU32();t=this.decodeBinary(g,4)}else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e){var v=this.lookU8();t=this.decodeExtension(v,1)}else if(200===e){var p=this.lookU16();t=this.decodeExtension(p,2)}else if(201===e){var y=this.lookU32();t=this.decodeExtension(y,4)}else throw new e3("Unrecognized type byte: ".concat(tn(e)));this.complete();for(var m=this.stack;m.length>0;){var _=m.top();if(_.type===tc)if(_.array[_.position]=t,_.position++,_.position===_.size)t=_.array,m.release(_);else continue t;else if(_.type===tl){if("__proto__"===t)throw new e3("The key __proto__ is not allowed");_.key=this.mapKeyConverter(t),_.type=tu;continue t}else if(_.map[_.key]=t,_.readCount++,_.readCount===_.size)t=_.map,m.release(_);else{_.key=null,_.type=tl;continue t}}return t}}},{key:"readHeadByte",value:function(){return -1===this.headByte&&(this.headByte=this.readU8()),this.headByte}},{key:"complete",value:function(){this.headByte=-1}},{key:"readArraySize",value:function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new e3("Unrecognized array type byte: ".concat(tn(e)))}}},{key:"pushMapState",value:function(e){if(e>this.maxMapLength)throw new e3("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.pushMapState(e)}},{key:"pushArrayState",value:function(e){if(e>this.maxArrayLength)throw new e3("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.pushArrayState(e)}},{key:"decodeString",value:function(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}},{key:"decodeUtf8String",value:function(e,t){if(e>this.maxStrLength)throw new e3("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw tv;var n,i,s=this.pos+t;return i=this.stateIsMapKey()&&(null==(n=this.keyDecoder)?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,s,e):function(e,t,n){var i;return n>200?(i=e.subarray(t,t+n),to.decode(i)):ts(e,t,n)}(this.bytes,s,e),this.pos+=t+e,i}},{key:"stateIsMapKey",value:function(){return this.stack.length>0&&this.stack.top().type===tl}},{key:"decodeBinary",value:function(e,t){if(e>this.maxBinLength)throw new e3("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw tv;var n=this.pos+t,i=this.bytes.subarray(n,n+e);return this.pos+=t+e,i}},{key:"decodeExtension",value:function(e,t){if(e>this.maxExtLength)throw new e3("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,n,this.context)}},{key:"lookU8",value:function(){return this.view.getUint8(this.pos)}},{key:"lookU16",value:function(){return this.view.getUint16(this.pos)}},{key:"lookU32",value:function(){return this.view.getUint32(this.pos)}},{key:"readU8",value:function(){var e=this.view.getUint8(this.pos);return this.pos++,e}},{key:"readI8",value:function(){var e=this.view.getInt8(this.pos);return this.pos++,e}},{key:"readU16",value:function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e}},{key:"readI16",value:function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e}},{key:"readU32",value:function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e}},{key:"readI32",value:function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e}},{key:"readU64",value:function(){var e,t,n=(e=this.view,t=this.pos,0x100000000*e.getUint32(t)+e.getUint32(t+4));return this.pos+=8,n}},{key:"readI64",value:function(){var e=e8(this.view,this.pos);return this.pos+=8,e}},{key:"readU64AsBigInt",value:function(){var e=this.view.getBigUint64(this.pos);return this.pos+=8,e}},{key:"readI64AsBigInt",value:function(){var e=this.view.getBigInt64(this.pos);return this.pos+=8,e}},{key:"readF32",value:function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e}},{key:"readF64",value:function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e}}]),e}();function tm(e,t){return new ty(t).decode(e)}var t_=function(){function e(t){var n,i,s,r,a,c,l,u;(0,o._)(this,e),this.entered=!1,this.extensionCodec=null!=(n=null==t?void 0:t.extensionCodec)?n:e9.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!=(i=null==t?void 0:t.useBigInt64)&&i,this.maxDepth=null!=(s=null==t?void 0:t.maxDepth)?s:100,this.initialBufferSize=null!=(r=null==t?void 0:t.initialBufferSize)?r:2048,this.sortKeys=null!=(a=null==t?void 0:t.sortKeys)&&a,this.forceFloat32=null!=(c=null==t?void 0:t.forceFloat32)&&c,this.ignoreUndefined=null!=(l=null==t?void 0:t.ignoreUndefined)&&l,this.forceIntegerToFloat=null!=(u=null==t?void 0:t.forceIntegerToFloat)&&u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return(0,r._)(e,[{key:"clone",value:function(){return new e({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}},{key:"reinitializeState",value:function(){this.pos=0}},{key:"encodeSharedRef",value:function(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}},{key:"encode",value:function(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}},{key:"doEncode",value:function(e,t){if(t>this.maxDepth)throw Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&(void 0===e?"undefined":(0,B._)(e))==="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}},{key:"ensureBufferSizeToWrite",value:function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)}},{key:"resizeBuffer",value:function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),i=new DataView(t);n.set(this.bytes),this.view=i,this.bytes=n}},{key:"encodeNil",value:function(){this.writeU8(192)}},{key:"encodeBoolean",value:function(e){!1===e?this.writeU8(194):this.writeU8(195)}},{key:"encodeNumber",value:function(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<0x100000000?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-0x80000000?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}},{key:"encodeNumberAsFloat",value:function(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}},{key:"encodeBigInt64",value:function(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}},{key:"writeStringHeader",value:function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<0x100000000)this.writeU8(219),this.writeU32(e);else throw Error("Too long string: ".concat(e," bytes in UTF-8"))}},{key:"encodeString",value:function(e){var t=function(e){for(var t=e.length,n=0,i=0;i<t;){var s=e.charCodeAt(i++);if((0xffffff80&s)==0){n++;continue}if((0xfffff800&s)==0)n+=2;else{if(s>=55296&&s<=56319&&i<t){var o=e.charCodeAt(i);(64512&o)==56320&&(++i,s=((1023&s)<<10)+(1023&o)+65536)}(0xffff0000&s)==0?n+=3:n+=4}}return n}(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),function(e,t,n){if(e.length>50)ti.encodeInto(e,t.subarray(n));else!function(e,t,n){for(var i=e.length,s=n,o=0;o<i;){var r=e.charCodeAt(o++);if((0xffffff80&r)==0){t[s++]=r;continue}if((0xfffff800&r)==0)t[s++]=r>>6&31|192;else{if(r>=55296&&r<=56319&&o<i){var a=e.charCodeAt(o);(64512&a)==56320&&(++o,r=((1023&r)<<10)+(1023&a)+65536)}(0xffff0000&r)==0?t[s++]=r>>12&15|224:(t[s++]=r>>18&7|240,t[s++]=r>>12&63|128),t[s++]=r>>6&63|128}t[s++]=63&r|128}}(e,t,n)}(e,this.bytes,this.pos),this.pos+=t}},{key:"encodeObject",value:function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if((void 0===e?"undefined":(0,B._)(e))==="object")this.encodeMap(e,t);else throw Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)))}},{key:"encodeBinary",value:function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<0x100000000)this.writeU8(198),this.writeU32(t);else throw Error("Too large binary: ".concat(t));var n=tr(e);this.writeU8a(n)}},{key:"encodeArray",value:function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else if(n<0x100000000)this.writeU8(221),this.writeU32(n);else throw Error("Too large array: ".concat(n));var i=!0,s=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;this.doEncode(c,t+1)}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}}},{key:"countWithoutUndefined",value:function(e,t){var n=0,i=!0,s=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;void 0!==e[c]&&n++}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}return n}},{key:"encodeMap",value:function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var i=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<0x100000000)this.writeU8(223),this.writeU32(i);else throw Error("Too large map object: ".concat(i));var s=!0,o=!1,r=void 0;try{for(var a,c=n[Symbol.iterator]();!(s=(a=c.next()).done);s=!0){var l=a.value,u=e[l];this.ignoreUndefined&&void 0===u||(this.encodeString(l),this.doEncode(u,t+1))}}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}}},{key:"encodeExtension",value:function(e){if("function"==typeof e.data){var t=e.data(this.pos+6),n=t.length;if(n>=0x100000000)throw Error("Too large extension object: ".concat(n));this.writeU8(201),this.writeU32(n),this.writeI8(e.type),this.writeU8a(t);return}var i=e.data.length;if(1===i)this.writeU8(212);else if(2===i)this.writeU8(213);else if(4===i)this.writeU8(214);else if(8===i)this.writeU8(215);else if(16===i)this.writeU8(216);else if(i<256)this.writeU8(199),this.writeU8(i);else if(i<65536)this.writeU8(200),this.writeU16(i);else if(i<0x100000000)this.writeU8(201),this.writeU32(i);else throw Error("Too large extension object: ".concat(i));this.writeI8(e.type),this.writeU8a(e.data)}},{key:"writeU8",value:function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}},{key:"writeU8a",value:function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}},{key:"writeI8",value:function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}},{key:"writeU16",value:function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}},{key:"writeI16",value:function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}},{key:"writeU32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}},{key:"writeI32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}},{key:"writeF32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}},{key:"writeF64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}},{key:"writeU64",value:function(e){var t,n;this.ensureBufferSizeToWrite(8),t=this.view,n=this.pos,t.setUint32(n,e/0x100000000),t.setUint32(n+4,e),this.pos+=8}},{key:"writeI64",value:function(e){this.ensureBufferSizeToWrite(8),e4(this.view,this.pos,e),this.pos+=8}},{key:"writeBigUint64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}},{key:"writeBigInt64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}]),e}();function tk(e,t){return new t_(t).encodeSharedRef(e)}var tS={RetriesExceeded:"conn_retry_exceeded",HandshakeFailed:"handshake_failed",MessageOrderingViolated:"message_ordering_violated",InvalidMessage:"invalid_message",MessageSendFailure:"message_send_failure"},tw=function(){function e(){(0,o._)(this,e),(0,a._)(this,"eventListeners",{})}return(0,r._)(e,[{key:"removeAllListeners",value:function(){this.eventListeners={}}},{key:"numberOfListeners",value:function(e){var t,n;return null!=(n=null==(t=this.eventListeners[e])?void 0:t.size)?n:0}},{key:"addEventListener",value:function(e,t){var n;this.eventListeners[e]||(this.eventListeners[e]=new Set),null==(n=this.eventListeners[e])||n.add(t)}},{key:"removeEventListener",value:function(e,t){var n;this.eventListeners[e]&&(null==(n=this.eventListeners[e])||n.delete(t))}},{key:"dispatchEvent",value:function(e,t){var n=this.eventListeners[e];if(n){var i=(0,h._)(n),s=!0,o=!1,r=void 0;try{for(var a,c=i[Symbol.iterator]();!(s=(a=c.next()).done);s=!0)(0,a.value)(t)}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}}}}]),e}(),tb=new TextEncoder,tC=new TextDecoder,tE={heartbeatIntervalMs:1e3,heartbeatsUntilDead:2,sessionDisconnectGraceMs:5e3,connectionTimeoutMs:2e3,handshakeTimeoutMs:1e3,enableTransparentSessionReconnects:!0,codec:{toBuffer:function(e){return tb.encode(JSON.stringify(e,function(e){var t,n=this[e];return(0,c._)(n,Uint8Array)?{$t:(t="",n.forEach(function(e){t+=String.fromCharCode(e)}),btoa(t))}:(void 0===n?"undefined":(0,B._)(n))==="bigint"?{$b:n.toString()}:n}))},fromBuffer:function(e){var t=JSON.parse(tC.decode(e),function(e,t){return(null==t?void 0:t.$t)!==void 0?function(e){for(var t=atob(e),n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n}(t.$t):(null==t?void 0:t.$b)!==void 0?BigInt(t.$b):t});if((void 0===t?"undefined":(0,B._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}}},tx=(0,l._)({},tE,{baseIntervalMs:150,maxJitterMs:200,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:200,isFatalConnectionError:function(){return!1}}),tT=(0,l._)({},tE),tM=((n=tM||{}).NoConnection="NoConnection",n.BackingOff="BackingOff",n.Connecting="Connecting",n.Handshaking="Handshaking",n.Connected="Connected",n.WaitingForHandshake="WaitingForHandshake",n),tI="session state has been consumed and is no longer valid",tB=function(e){function t(e){var n,i=e.from,s=e.options,r=e.log,c=e.tracer,l=e.codec;return(0,o._)(this,t),n=(0,eG._)(this,t),(0,a._)(n,"from",void 0),(0,a._)(n,"options",void 0),(0,a._)(n,"codec",void 0),(0,a._)(n,"tracer",void 0),(0,a._)(n,"log",void 0),n.from=i,n.options=s,n.log=r,n.tracer=c,n.codec=l,n}return(0,eQ._)(t,e),t}(function(){function e(){return(0,o._)(this,e),(0,a._)(this,"_isConsumed",void 0),this._isConsumed=!1,new Proxy(this,{get:function(e,t){if("_isConsumed"===t||"id"===t||"state"===t)return Reflect.get(e,t);if("_handleStateExit"===t)return function(){e._isConsumed=!0,e._handleStateExit()};if("_handleClose"===t)return function(){e._isConsumed=!0,e._handleStateExit(),e._handleClose()};if(e._isConsumed)throw Error("".concat(tI,": getting ").concat(t.toString()," on consumed state"));return Reflect.get(e,t)},set:function(e,t,n){if(e._isConsumed)throw Error("".concat(tI,": setting ").concat(t.toString()," on consumed state"));return Reflect.set(e,t,n)}})}return(0,r._)(e,[{key:"close",value:function(){this._handleClose()}}]),e}()),tU=function(e){function t(e){(0,o._)(this,t);var n,i=e.id,s=e.to,r=e.seq,c=e.ack,l=e.sendBuffer,u=e.telemetry,d=e.log,h=e.protocolVersion,f=e.seqSent;return n=(0,eG._)(this,t,[e]),(0,a._)(n,"id",void 0),(0,a._)(n,"telemetry",void 0),(0,a._)(n,"to",void 0),(0,a._)(n,"protocolVersion",void 0),(0,a._)(n,"seq",void 0),(0,a._)(n,"seqSent",void 0),(0,a._)(n,"ack",void 0),(0,a._)(n,"sendBuffer",void 0),n.id=i,n.to=s,n.seq=r,n.ack=c,n.sendBuffer=l,n.telemetry=u,n.log=d,n.protocolVersion=h,n.seqSent=f,n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"loggingMetadata",get:function(){var e={clientId:this.from,connectedTo:this.to,sessionId:this.id};if(this.telemetry.span.isRecording()){var t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}},{key:"constructMsg",value:function(e){var t=(0,u._)((0,l._)({},e),{id:eh(),to:this.to,from:this.from,seq:this.seq,ack:this.ack});return this.seq++,t}},{key:"nextSeq",value:function(){return this.sendBuffer.length>0?this.sendBuffer[0].seq:this.seq}},{key:"send",value:function(e){var t=this.constructMsg(e);return this.sendBuffer.push(t),{ok:!0,value:t.id}}},{key:"_handleStateExit",value:function(){}},{key:"_handleClose",value:function(){this.sendBuffer.length=0,this.telemetry.span.end()}}]),t}(tB),tL=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"graceExpiryTime",void 0),(0,a._)(n,"gracePeriodTimeout",void 0),(0,a._)(n,"listeners",void 0),n.listeners=e.listeners,n.graceExpiryTime=e.graceExpiryTime,n.gracePeriodTimeout=setTimeout(function(){n.listeners.onSessionGracePeriodElapsed()},n.graceExpiryTime-Date.now()),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this),this.gracePeriodTimeout&&(clearTimeout(this.gracePeriodTimeout),this.gracePeriodTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this)}}]),t}(tU);function tH(e,t,n){var i=t.toBuffer(n);return i.ok?e.send(i.value)?{ok:!0,value:n.id}:{ok:!1,reason:"failed to send message"}:i}var tA=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"state","Connecting"),(0,a._)(n,"connPromise",void 0),(0,a._)(n,"listeners",void 0),(0,a._)(n,"connectionTimeout",void 0),n.connPromise=e.connPromise,n.listeners=e.listeners,n.connPromise.then(function(e){n._isConsumed||n.listeners.onConnectionEstablished(e)},function(e){n._isConsumed||n.listeners.onConnectionFailed(e)}),n.connectionTimeout=setTimeout(function(){n.listeners.onConnectionTimeout()},n.options.connectionTimeoutMs),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"bestEffortClose",value:function(){var e=this.log,t=this.loggingMetadata;this.connPromise.then(function(n){n.close(),null==e||e.info("connection eventually resolved but session has transitioned, closed connection",(0,l._)({},t,n.loggingMetadata))}).catch(function(){})}},{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this),this.bestEffortClose()}}]),t}(tL),tR=function(e){function t(){var e;return(0,o._)(this,t),e=(0,eG._)(this,t,arguments),(0,a._)(e,"state","NoConnection"),e}return(0,eQ._)(t,e),(0,r._)(t,[{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this)}}]),t}(tL),tN=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"state","WaitingForHandshake"),(0,a._)(n,"conn",void 0),(0,a._)(n,"listeners",void 0),(0,a._)(n,"handshakeTimeout",void 0),(0,a._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"loggingMetadata",get:function(){return(0,l._)({clientId:this.from,connId:this.conn.id},this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return tH(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0}},{key:"_handleClose",value:function(){this.conn.close()}}]),t}(tB),tO=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"state","Handshaking"),(0,a._)(n,"conn",void 0),(0,a._)(n,"listeners",void 0),(0,a._)(n,"handshakeTimeout",void 0),(0,a._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"loggingMetadata",get:function(){return(0,l._)({},(0,eJ._)((0,e$._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return tH(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),this.handshakeTimeout&&(clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(tL),tD=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"state","Connected"),(0,a._)(n,"conn",void 0),(0,a._)(n,"listeners",void 0),(0,a._)(n,"heartbeatHandle",void 0),(0,a._)(n,"heartbeatMissTimeout",void 0),(0,a._)(n,"isActivelyHeartbeating",!1),(0,a._)(n,"onMessageData",function(e){var t=n.codec.fromBuffer(e);if(!t.ok)return void n.listeners.onInvalidMessage("could not parse message: ".concat(t.reason));var i=t.value;if(i.seq!==n.ack){if(i.seq<n.ack)null==(r=n.log)||r.debug("received duplicate msg (got seq: ".concat(i.seq,", wanted seq: ").concat(n.ack,"), discarding"),(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:i}));else{var s,o,r,a,c="received out-of-order msg, closing connection (got seq: ".concat(i.seq,", wanted seq: ").concat(n.ack,")");null==(a=n.log)||a.error(c,(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:i,tags:["invariant-violation"]})),n.telemetry.span.setStatus({code:m.SpanStatusCode.ERROR,message:c}),n.conn.close()}return}(null==(s=n.log)||s.debug("received msg",(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:i})),n.updateBookkeeping(i.ack,i.seq),eB(i.controlFlags))?(null==(o=n.log)||o.debug("discarding msg (ack bit set)",(0,u._)((0,l._)({},n.loggingMetadata),{transportMessage:i})),n.isActivelyHeartbeating||n.sendHeartbeat()):n.listeners.onMessage(i)}),n.conn=e.conn,n.listeners=e.listeners,n.conn.setDataListener(n.onMessageData),n.conn.setCloseListener(n.listeners.onConnectionClosed),n.conn.setErrorListener(n.listeners.onConnectionErrored),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"updateBookkeeping",value:function(e,t){this.sendBuffer=this.sendBuffer.filter(function(t){return t.seq>=e}),this.ack=t+1,this.heartbeatMissTimeout&&clearTimeout(this.heartbeatMissTimeout),this.startMissingHeartbeatTimeout()}},{key:"assertSendOrdering",value:function(e){if(e.seq>this.seqSent+1){var t,n="invariant violation: would have sent out of order msg (seq: ".concat(e.seq,", expected: ").concat(this.seqSent," + 1)");throw null==(t=this.log)||t.error(n,(0,u._)((0,l._)({},this.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),Error(n)}}},{key:"send",value:function(e){var t=this.constructMsg(e);this.assertSendOrdering(t),this.sendBuffer.push(t);var n=tH(this.conn,this.codec,t);return n.ok?this.seqSent=t.seq:this.listeners.onMessageSendFailure(t,n.reason),n}},{key:"sendBufferedMessages",value:function(){if(this.sendBuffer.length>0){null==(i=this.log)||i.info("sending ".concat(this.sendBuffer.length," buffered messages, starting at seq ").concat(this.nextSeq()),this.loggingMetadata);var e=!0,t=!1,n=void 0;try{for(var i,s,o=this.sendBuffer[Symbol.iterator]();!(e=(s=o.next()).done);e=!0){var r=s.value;this.assertSendOrdering(r);var a=tH(this.conn,this.codec,r);if(!a.ok)return this.listeners.onMessageSendFailure(r,a.reason),a;this.seqSent=r.seq}}catch(e){t=!0,n=e}finally{try{e||null==o.return||o.return()}finally{if(t)throw n}}}return{ok:!0,value:void 0}}},{key:"loggingMetadata",get:function(){return(0,l._)({},(0,eJ._)((0,e$._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"startMissingHeartbeatTimeout",value:function(){var e=this,t=this.options.heartbeatsUntilDead,n=t*this.options.heartbeatIntervalMs;this.heartbeatMissTimeout=setTimeout(function(){var i;null==(i=e.log)||i.info("closing connection to ".concat(e.to," due to inactivity (missed ").concat(t," heartbeats which is ").concat(n,"ms)"),e.loggingMetadata),e.telemetry.span.addEvent("closing connection due to missing heartbeat"),e.conn.close()},n)}},{key:"startActiveHeartbeat",value:function(){var e=this;this.isActivelyHeartbeating=!0,this.heartbeatHandle=setInterval(function(){e.sendHeartbeat()},this.options.heartbeatIntervalMs)}},{key:"sendHeartbeat",value:function(){var e;null==(e=this.log)||e.debug("sending heartbeat",this.loggingMetadata),this.send({streamId:"heartbeat",controlFlags:1,payload:{type:"ACK"}})}},{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeCloseListener(),this.conn.removeErrorListener(),this.heartbeatHandle&&(clearInterval(this.heartbeatHandle),this.heartbeatHandle=void 0),this.heartbeatMissTimeout&&(clearTimeout(this.heartbeatMissTimeout),this.heartbeatMissTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(tU),tq=function(e){function t(e){var n;return(0,o._)(this,t),n=(0,eG._)(this,t,[e]),(0,a._)(n,"state","BackingOff"),(0,a._)(n,"listeners",void 0),(0,a._)(n,"backoffTimeout",void 0),n.listeners=e.listeners,n.backoffTimeout=setTimeout(function(){n.listeners.onBackoffFinished()},e.backoffMs),n}return(0,eQ._)(t,e),(0,r._)(t,[{key:"_handleClose",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,eJ._)((0,e$._)(t.prototype),"_handleStateExit",this).call(this),this.backoffTimeout&&(clearTimeout(this.backoffTimeout),this.backoffTimeout=void 0)}}]),t}(tL),tF=new e9;tF.register({type:0,encode:function(e){return(void 0===e?"undefined":(0,B._)(e))!=="bigint"?null:e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?tk(Number(e)):tk(String(e))},decode:function(e){var t=tm(e);if("string"!=typeof t&&"number"!=typeof t)throw new e3("unexpected BigInt source: ".concat(void 0===t?"undefined":(0,B._)(t)));return BigInt(t)}});var tP={toBuffer:function(e){return tk(e,{ignoreUndefined:!0,initialBufferSize:512,extensionCodec:tF})},fromBuffer:function(e){var t=tm(e,{extensionCodec:tF});if((void 0===t?"undefined":(0,B._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}},tV=function(){function e(t){(0,o._)(this,e),this.codec=t}return(0,r._)(e,[{key:"toBuffer",value:function(e){try{return{ok:!0,value:this.codec.toBuffer(e)}}catch(e){return{ok:!1,reason:eP(e)}}}},{key:"fromBuffer",value:function(e){try{var t=this.codec.fromBuffer(e);if(!j.Value.Check(eE,t))return{ok:!1,reason:"transport message schema mismatch"};return{ok:!0,value:t}}catch(e){return{ok:!1,reason:eP(e)}}}}]),e}();function tj(e){return{id:e.id,from:e.from,to:e.to,seq:e.seq,ack:e.ack,seqSent:e.seqSent,sendBuffer:e.sendBuffer,telemetry:e.telemetry,options:e.options,log:e.log,tracer:e.tracer,protocolVersion:e.protocolVersion,codec:e.codec}}function tz(e){return(0,u._)((0,l._)({},tj(e)),{graceExpiryTime:e.graceExpiryTime})}var tK=function(e,t,n,i,s,o,r){var a,c="session-".concat(eh()),d=eL(o,c,e,t),h=new tR({listeners:n,id:c,from:t,to:e,seq:0,ack:0,seqSent:0,graceExpiryTime:Date.now()+i.sessionDisconnectGraceMs,sendBuffer:[],telemetry:d,options:i,protocolVersion:s,tracer:o,log:r,codec:new tV(i.codec)});return null==(a=h.log)||a.info("session ".concat(h.id," created in NoConnection state"),(0,u._)((0,l._)({},h.loggingMetadata),{tags:["state-transition"]})),h},tW=function(e,t,n,i,s,o){var r,a=new tN({conn:t,listeners:n,from:e,options:i,tracer:s,log:o,codec:new tV(i.codec)});return null==(r=a.log)||r.info("session created in WaitingForHandshake state",(0,u._)((0,l._)({},a.loggingMetadata),{tags:["state-transition"]})),a},tG={NoConnectionToBackingOff:function(e,t,n){var i,s=tz(e);e._handleStateExit();var o=new tq((0,l._)({backoffMs:t,listeners:n},s));return null==(i=o.log)||i.info("session ".concat(o.id," transition from NoConnection to BackingOff"),(0,u._)((0,l._)({},o.loggingMetadata),{tags:["state-transition"]})),o},BackingOffToConnecting:function(e,t,n){var i,s=tz(e);e._handleStateExit();var o=new tA((0,l._)({connPromise:t,listeners:n},s));return null==(i=o.log)||i.info("session ".concat(o.id," transition from BackingOff to Connecting"),(0,u._)((0,l._)({},o.loggingMetadata),{tags:["state-transition"]})),o},ConnectingToHandshaking:function(e,t,n){var i,s=tz(e);e._handleStateExit();var o=new tO((0,l._)({conn:t,listeners:n},s));return t.telemetry=eH(o.tracer,t,o.telemetry),null==(i=o.log)||i.info("session ".concat(o.id," transition from Connecting to Handshaking"),(0,u._)((0,l._)({},o.loggingMetadata),{tags:["state-transition"]})),o},HandshakingToConnected:function(e,t){var n,i=tj(e),s=e.conn;e._handleStateExit();var o=new tD((0,l._)({conn:s,listeners:t},i));return o.startMissingHeartbeatTimeout(),null==(n=o.log)||n.info("session ".concat(o.id," transition from Handshaking to Connected"),(0,u._)((0,l._)({},o.loggingMetadata),{tags:["state-transition"]})),o},WaitingForHandshakeToConnected:function(e,t,n,i,s,o,r){var a,c=e.conn,d=e.from,h=e.options,f=t?tj(t):{id:n,from:d,to:i,seq:0,ack:0,seqSent:0,sendBuffer:[],telemetry:eL(e.tracer,n,i,d,s),options:h,tracer:e.tracer,log:e.log,protocolVersion:r,codec:new tV(h.codec)};e._handleStateExit(),null==t||t._handleStateExit();var g=new tD((0,l._)({conn:c,listeners:o},f));return g.startMissingHeartbeatTimeout(),c.telemetry=eH(g.tracer,c,g.telemetry),null==(a=g.log)||a.info("session ".concat(g.id," transition from WaitingForHandshake to Connected"),(0,u._)((0,l._)({},g.loggingMetadata),{tags:["state-transition"]})),g},BackingOffToNoConnection:function(e,t){var n,i=tz(e);e._handleStateExit();var s=new tR((0,l._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from BackingOff to NoConnection"),(0,u._)((0,l._)({},s.loggingMetadata),{tags:["state-transition"]})),s},ConnectingToNoConnection:function(e,t){var n,i=tz(e);e.bestEffortClose(),e._handleStateExit();var s=new tR((0,l._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from Connecting to NoConnection"),(0,u._)((0,l._)({},s.loggingMetadata),{tags:["state-transition"]})),s},HandshakingToNoConnection:function(e,t){var n,i=tz(e);e.conn.close(),e._handleStateExit();var s=new tR((0,l._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from Handshaking to NoConnection"),(0,u._)((0,l._)({},s.loggingMetadata),{tags:["state-transition"]})),s},ConnectedToNoConnection:function(e,t){var n,i=tj(e),s=Date.now()+e.options.sessionDisconnectGraceMs;e.conn.close(),e._handleStateExit();var o=new tR((0,l._)({listeners:t,graceExpiryTime:s},i));return null==(n=o.log)||n.info("session ".concat(o.id," transition from Connected to NoConnection"),(0,u._)((0,l._)({},o.loggingMetadata),{tags:["state-transition"]})),o}},tJ={entrypoint:tK,transition:{NoConnectionToBackingOff:tG.NoConnectionToBackingOff,BackingOffToConnecting:tG.BackingOffToConnecting,ConnectingToHandshaking:tG.ConnectingToHandshaking,HandshakingToConnected:tG.HandshakingToConnected,BackingOffToNoConnection:tG.BackingOffToNoConnection,ConnectingToNoConnection:tG.ConnectingToNoConnection,HandshakingToNoConnection:tG.HandshakingToNoConnection,ConnectedToNoConnection:tG.ConnectedToNoConnection}},t$={entrypoint:tW,transition:{WaitingForHandshakeToConnected:tG.WaitingForHandshakeToConnected,ConnectedToNoConnection:tG.ConnectedToNoConnection}},tQ=function(){function e(t,n){(0,o._)(this,e),(0,a._)(this,"status",void 0),(0,a._)(this,"clientId",void 0),(0,a._)(this,"eventDispatcher",void 0),(0,a._)(this,"options",void 0),(0,a._)(this,"log",void 0),(0,a._)(this,"tracer",void 0),(0,a._)(this,"sessions",void 0),this.options=(0,l._)({},tE,n),this.eventDispatcher=new tw,this.clientId=t,this.status="open",this.sessions=new Map,this.tracer=eR()}return(0,r._)(e,[{key:"bindLogger",value:function(e,t){if("function"==typeof e){this.log=e2(new e1(e,t));return}this.log=e2(e)}},{key:"handleMsg",value:function(e){"open"===this.getStatus()&&this.eventDispatcher.dispatchEvent("message",e)}},{key:"addEventListener",value:function(e,t){this.eventDispatcher.addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){this.eventDispatcher.removeEventListener(e,t)}},{key:"protocolError",value:function(e){this.eventDispatcher.dispatchEvent("protocolError",e)}},{key:"close",value:function(){this.status="closed";var e=Array.from(this.sessions.values()),t=!0,n=!1,i=void 0;try{for(var s,o,r=e[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;this.deleteSession(a)}}catch(e){n=!0,i=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw i}}this.eventDispatcher.dispatchEvent("transportStatus",{status:this.status}),this.eventDispatcher.removeAllListeners(),null==(s=this.log)||s.info("manually closed transport",{clientId:this.clientId})}},{key:"getStatus",value:function(){return this.status}},{key:"createSession",value:function(e){var t=this.sessions.get(e.to);if(t){var n,i="attempt to create session for ".concat(e.to," but active session (").concat(t.id,") already exists");throw null==(n=this.log)||n.error(i,(0,u._)((0,l._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(i)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"created",session:e}),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"updateSession",value:function(e){var t=this.sessions.get(e.to);if(!t){var n,i="attempt to transition session for ".concat(e.to," but no active session exists");throw null==(n=this.log)||n.error(i,(0,u._)((0,l._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(i)}if(t.id!==e.id){var s,o="attempt to transition active session for ".concat(e.to," but active session (").concat(t.id,") is different from handle (").concat(e.id,")");throw null==(s=this.log)||s.error(o,(0,u._)((0,l._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(o)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"deleteSession",value:function(e,t){if(!e._isConsumed){var n,i=e.loggingMetadata;i.tags&&(null==t?void 0:t.unhealthy)&&i.tags.push("unhealthy-session"),null==(n=e.log)||n.info("closing session ".concat(e.id),i),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closing",session:e});var s=e.to;e.close(),this.sessions.delete(s),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closed",session:{id:e.id,to:s}})}}},{key:"onSessionGracePeriodElapsed",value:function(e){var t;null==(t=this.log)||t.info("session to ".concat(e.to," grace period elapsed, closing"),e.loggingMetadata),this.deleteSession(e)}},{key:"onConnectingFailed",value:function(e){var t=this,n=tG.ConnectingToNoConnection(e,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}});return this.updateSession(n),n}},{key:"onConnClosed",value:function(e){var t,n=this;return t="Handshaking"===e.state?tG.HandshakingToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}):tG.ConnectedToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}),this.updateSession(t),t}},{key:"getSessionBoundSendFn",value:function(e,t){var n=this;if("open"!==this.getStatus())throw Error("cannot get a bound send function on a closed transport");return function(i){var s=n.sessions.get(e);if(!s)throw Error("session scope for ".concat(t," has ended (close), can't send"));if(s.id!==t||s._isConsumed)throw Error("session scope for ".concat(t," has ended (transition), can't send"));var o=s.send(i);if(!o.ok)throw Error(o.reason);return o.value}}}]),e}(),tX=function(){function e(t){(0,o._)(this,e),(0,a._)(this,"budgetConsumed",void 0),(0,a._)(this,"intervalHandle",void 0),(0,a._)(this,"options",void 0),this.options=t,this.budgetConsumed=0}return(0,r._)(e,[{key:"getBackoffMs",value:function(){if(0===this.getBudgetConsumed())return 0;var e=Math.max(0,this.getBudgetConsumed()-1),t=Math.floor(Math.random()*this.options.maxJitterMs);return Math.min(this.options.baseIntervalMs*Math.pow(2,e),this.options.maxBackoffMs)+t}},{key:"totalBudgetRestoreTime",get:function(){return this.options.budgetRestoreIntervalMs*this.options.attemptBudgetCapacity}},{key:"consumeBudget",value:function(){this.stopLeak(),this.budgetConsumed=this.getBudgetConsumed()+1}},{key:"getBudgetConsumed",value:function(){return this.budgetConsumed}},{key:"hasBudget",value:function(){return this.getBudgetConsumed()<this.options.attemptBudgetCapacity}},{key:"startRestoringBudget",value:function(){var e=this;this.intervalHandle||(this.intervalHandle=setInterval(function(){var t=e.budgetConsumed;if(!t)return void e.stopLeak();var n=t-1;0!==n&&(e.budgetConsumed=n)},this.options.budgetRestoreIntervalMs))}},{key:"stopLeak",value:function(){this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0)}},{key:"close",value:function(){this.stopLeak()}}]),e}(),tY=function(e){function t(e,n){var i;return(0,o._)(this,t),i=(0,eG._)(this,t,[e,n]),(0,a._)(i,"options",void 0),(0,a._)(i,"retryBudget",void 0),(0,a._)(i,"reconnectOnConnectionDrop",!0),(0,a._)(i,"handshakeExtensions",void 0),(0,a._)(i,"sessions",void 0),i.sessions=new Map,i.options=(0,l._)({},tx,n),i.retryBudget=new tX(i.options),i}return(0,eQ._)(t,e),(0,r._)(t,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"tryReconnecting",value:function(e){var t=this.sessions.get(e);!this.options.enableTransparentSessionReconnects&&t&&this.deleteSession(t),this.reconnectOnConnectionDrop&&"open"===this.getStatus()&&this.connect(e)}},{key:"createUnconnectedSession",value:function(e){var t=this,n=tJ.entrypoint(e,this.clientId,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}},this.options,ev,this.tracer,this.log);return this.createSession(n),n}},{key:"onConnectingFailed",value:function(e){var n=(0,eJ._)((0,e$._)(t.prototype),"onConnectingFailed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnClosed",value:function(e){var n=(0,eJ._)((0,e$._)(t.prototype),"onConnClosed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnectionEstablished",value:function(e,t){var n=this,i=tJ.transition.ConnectingToHandshaking(e,t,{onConnectionErrored:function(e){var t,s=eP(e);null==(t=n.log)||t.error("connection to ".concat(i.to," errored during handshake: ").concat(s),i.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection to ".concat(i.to," closed during handshake"),i.loggingMetadata),n.onConnClosed(i)},onHandshake:function(e){n.onHandshakeResponse(i,e)},onInvalidHandshake:function(t,s){var o;null==(o=n.log)||o.error("invalid handshake: ".concat(t),i.loggingMetadata),n.deleteSession(e,{unhealthy:!0}),n.protocolError({type:tS.HandshakeFailed,code:s,message:t})},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.error("connection to ".concat(i.to," timed out during handshake"),i.loggingMetadata),n.onConnClosed(i)},onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(i)}});return this.updateSession(i),this.sendHandshake(i),i}},{key:"rejectHandshakeResponse",value:function(e,t,n){var i,s;null==(i=e.conn.telemetry)||i.span.setStatus({code:m.SpanStatusCode.ERROR,message:t}),null==(s=this.log)||s.warn(t,n),this.deleteSession(e,{unhealthy:!0})}},{key:"onHandshakeResponse",value:function(e,t){var n,i=this;if(!j.Value.Check(eb,t.payload))return void this.rejectHandshakeResponse(e,"received invalid handshake response",(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:t,validationErrors:(0,h._)(j.Value.Errors(eb,t.payload))}));if(!t.payload.status.ok){var s=j.Value.Check(e_,t.payload.status.code),o="handshake failed: ".concat(t.payload.status.reason),r=e.to;this.rejectHandshakeResponse(e,o,(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:t})),s?this.tryReconnecting(r):this.protocolError({type:tS.HandshakeFailed,code:t.payload.status.code,message:o});return}if(t.payload.status.sessionId!==e.id){var a="session id mismatch: expected ".concat(e.id,", got ").concat(t.payload.status.sessionId);this.rejectHandshakeResponse(e,a,(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:t}));return}null==(n=this.log)||n.info("handshake from ".concat(t.from," ok"),(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:t}));var d=tJ.transition.HandshakingToConnected(e,{onConnectionErrored:function(e){var t,n,s=eP(e);(0,c._)(e,Error)&&i.options.isFatalConnectionError(e)?(null==(t=i.log)||t.warn("connection to ".concat(d.to," fatally errored: ").concat(s),d.loggingMetadata),i.reconnectOnConnectionDrop=!1):null==(n=i.log)||n.warn("connection to ".concat(d.to," errored: ").concat(s),d.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=i.log)||e.info("connection to ".concat(d.to," closed"),d.loggingMetadata),i.onConnClosed(d)},onMessage:function(e){i.handleMsg(e)},onInvalidMessage:function(e){var n;null==(n=i.log)||n.error("invalid message: ".concat(e),(0,u._)((0,l._)({},d.loggingMetadata),{transportMessage:t})),i.protocolError({type:tS.InvalidMessage,message:e}),i.deleteSession(d,{unhealthy:!0})},onMessageSendFailure:function(e,t){var n;null==(n=i.log)||n.error("failed to send message: ".concat(t),(0,u._)((0,l._)({},d.loggingMetadata),{transportMessage:e})),i.protocolError({type:tS.MessageSendFailure,message:t}),i.deleteSession(d,{unhealthy:!0})}});d.sendBufferedMessages().ok&&(this.updateSession(d),this.retryBudget.startRestoringBudget())}},{key:"connect",value:function(e){var t=this;if("open"!==this.getStatus()){null==(s=this.log)||s.info("transport state is no longer open, cancelling attempt to connect to ".concat(e));return}var n=null!=(o=this.sessions.get(e))?o:this.createUnconnectedSession(e);if("NoConnection"!==n.state){null==(r=this.log)||r.debug("session to ".concat(e," has state ").concat(n.state,", skipping connect attempt"),n.loggingMetadata);return}if(!this.retryBudget.hasBudget()){var i,s,o,r,a,c=this.retryBudget.getBudgetConsumed(),l="tried to connect to ".concat(e," but retry budget exceeded (more than ").concat(c," attempts in the last ").concat(this.retryBudget.totalBudgetRestoreTime,"ms)");null==(a=this.log)||a.error(l,n.loggingMetadata),this.protocolError({type:tS.RetriesExceeded,message:l});return}var u=this.retryBudget.getBackoffMs();null==(i=this.log)||i.info("attempting connection to ".concat(e," (").concat(u,"ms backoff)"),n.loggingMetadata),this.retryBudget.consumeBudget();var d=tJ.transition.NoConnectionToBackingOff(n,u,{onBackoffFinished:function(){t.onBackoffFinished(d)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(d)}});this.updateSession(d)}},{key:"hardDisconnect",value:function(){var e=Array.from(this.sessions.values()),t=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(t=(s=o.next()).done);t=!0){var r=s.value;this.deleteSession(r)}}catch(e){n=!0,i=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw i}}}},{key:"onBackoffFinished",value:function(e){var t=this,n=e.tracer.startActiveSpan("connect",function(n){return(0,s._)(function(){var t,i;return(0,f._)(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,3,4]),[4,this.createNewOutgoingConnection(e.to)];case 1:return[2,s.sent()];case 2:throw i=eP(t=s.sent()),n.recordException(i),n.setStatus({code:m.SpanStatusCode.ERROR}),t;case 3:return n.end(),[7];case 4:return[2]}})}).call(t)}),i=tJ.transition.BackingOffToConnecting(e,n,{onConnectionEstablished:function(e){var n;null==(n=t.log)||n.debug("connection to ".concat(i.to," established"),(0,l._)({},e.loggingMetadata,i.loggingMetadata)),t.onConnectionEstablished(i,e)},onConnectionFailed:function(e){var n,s=eP(e);null==(n=t.log)||n.error("error connecting to ".concat(i.to,": ").concat(s),i.loggingMetadata),t.onConnectingFailed(i)},onConnectionTimeout:function(){var e;null==(e=t.log)||e.error("connection to ".concat(i.to," timed out"),i.loggingMetadata),t.onConnectingFailed(i)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(i)}});this.updateSession(i)}},{key:"sendHandshake",value:function(e){return(0,s._)(function(){var t,n,i,s,o,r,a;return(0,f._)(this,function(c){switch(c.label){case 0:if(n=void 0,!this.handshakeExtensions)return[3,4];c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.handshakeExtensions.construct()];case 2:return n=c.sent(),[3,4];case 3:return s=eP(c.sent()),null==(i=this.log)||i.error("failed to construct handshake metadata for session to ".concat(e.to,": ").concat(s),e.loggingMetadata),this.protocolError({type:tS.HandshakeFailed,message:"failed to construct handshake metadata: ".concat(s)}),this.deleteSession(e,{unhealthy:!0}),[2];case 4:if(e._isConsumed)return[2];return o=ex({from:this.clientId,to:e.to,sessionId:e.id,expectedSessionState:{nextExpectedSeq:e.ack,nextSentSeq:e.nextSeq()},metadata:n,tracing:eU(e.telemetry.ctx)}),null==(t=this.log)||t.debug("sending handshake request to ".concat(e.to),(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:o})),(r=e.sendHandshake(o)).ok||(null==(a=this.log)||a.error("failed to send handshake request: ".concat(r.reason),(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:o})),this.protocolError({type:tS.MessageSendFailure,message:r.reason}),this.deleteSession(e,{unhealthy:!0})),[2]}})}).call(this)}},{key:"close",value:function(){this.retryBudget.close(),(0,eJ._)((0,e$._)(t.prototype),"close",this).call(this)}}]),t}(tQ);function tZ(e,t){var n,i;return(0,o._)(this,tZ),n=(0,eG._)(this,tZ,[e,t]),(0,a._)(n,"options",void 0),(0,a._)(n,"handshakeExtensions",void 0),(0,a._)(n,"sessionHandshakeMetadata",new Map),(0,a._)(n,"sessions",new Map),(0,a._)(n,"pendingSessions",new Set),n.sessions=new Map,n.options=(0,l._)({},tT,t),null==(i=n.log)||i.info("initiated server transport",{clientId:n.clientId,protocolVersion:ev}),n}(0,eQ._)(tZ,tQ),(0,r._)(tZ,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"deletePendingSession",value:function(e){e.close(),this.pendingSessions.delete(e)}},{key:"deleteSession",value:function(e,t){this.sessionHandshakeMetadata.delete(e.to),(0,eJ._)((0,e$._)(tZ.prototype),"deleteSession",this).call(this,e,t)}},{key:"handleConnection",value:function(e){var t,n=this;if("open"===this.getStatus()){null==(t=this.log)||t.info("new incoming connection",(0,u._)((0,l._)({},e.loggingMetadata),{clientId:this.clientId}));var i=!1,s=t$.entrypoint(this.clientId,e,{onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection from unknown closed before handshake finished",s.loggingMetadata),n.deletePendingSession(s)},onConnectionErrored:function(e){var t,i=eP(e);null==(t=n.log)||t.warn("connection from unknown errored before handshake finished: ".concat(i),s.loggingMetadata),n.deletePendingSession(s)},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.warn("connection from unknown timed out before handshake finished",s.loggingMetadata),n.deletePendingSession(s)},onHandshake:function(e){if(i){var t;null==(t=n.log)||t.error("received multiple handshake messages from pending session",(0,u._)((0,l._)({},s.loggingMetadata),{connectedTo:e.from,transportMessage:e})),n.deletePendingSession(s);return}i=!0,n.onHandshakeRequest(s,e)},onInvalidHandshake:function(e,t){var i;null==(i=n.log)||i.error("invalid handshake: ".concat(e),s.loggingMetadata),n.deletePendingSession(s),n.protocolError({type:tS.HandshakeFailed,code:t,message:e})}},this.options,this.tracer,this.log);this.pendingSessions.add(s)}}},{key:"rejectHandshakeRequest",value:function(e,t,n,i,s){null==(o=e.conn.telemetry)||o.span.setStatus({code:m.SpanStatusCode.ERROR,message:n}),null==(r=this.log)||r.warn(n,s);var o,r,a,c=eT({from:this.clientId,to:t,status:{ok:!1,code:i,reason:n}}),d=e.sendHandshake(c);if(!d.ok){null==(a=this.log)||a.error("failed to send handshake response: ".concat(d.reason),(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:c})),this.protocolError({type:tS.MessageSendFailure,message:d.reason}),this.deletePendingSession(e);return}this.protocolError({type:tS.HandshakeFailed,code:i,message:n}),this.deletePendingSession(e)}},{key:"onHandshakeRequest",value:function(e,t){return(0,s._)(function(){var n,i,s,o,r,a,c,d,g,v,p,y,m,_,k,S,w,b,C,E;return(0,f._)(this,function(f){switch(f.label){case 0:if(n=this,!j.Value.Check(em,t.payload))return this.rejectHandshakeRequest(e,t.from,"received invalid handshake request","MALFORMED_HANDSHAKE",(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:t,connectedTo:t.from,validationErrors:(0,h._)(j.Value.Errors(em,t.payload))})),[2];if(!ey(s=t.payload.protocolVersion))return this.rejectHandshakeRequest(e,t.from,"expected protocol version oneof [".concat(ep.toString(),"], got ").concat(s),"PROTOCOL_VERSION_MISMATCH",(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(o={},!this.handshakeExtensions)return[3,2];if(!j.Value.Check(this.handshakeExtensions.schema,t.payload.metadata))return this.rejectHandshakeRequest(e,t.from,"received malformed handshake metadata","MALFORMED_HANDSHAKE_META",(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,validationErrors:(0,h._)(j.Value.Errors(this.handshakeExtensions.schema,t.payload.metadata))})),[2];return r=this.sessionHandshakeMetadata.get(t.from),[4,this.handshakeExtensions.validate(t.payload.metadata,r)];case 1:if(a=f.sent(),e._isConsumed)return[2];if(j.Value.Check(ek,a))return this.rejectHandshakeRequest(e,t.from,"rejected by handshake handler",a,(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,clientId:this.clientId})),[2];o=a,f.label=2;case 2:if(c="new session",d=t.payload.expectedSessionState.nextExpectedSeq,g=t.payload.expectedSessionState.nextSentSeq,v=this.sessions.get(t.from),this.options.enableTransparentSessionReconnects&&v&&v.id===t.payload.sessionId){if(c="transparent reconnection",p=v.nextSeq(),g>(y=v.ack))return this.rejectHandshakeRequest(e,t.from,"client is in the future: server wanted next message to be ".concat(y," but client would have sent ").concat(g),"SESSION_STATE_MISMATCH",(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(p>d)return this.rejectHandshakeRequest(e,t.from,"server is in the future: client wanted next message to be ".concat(d," but server would have sent ").concat(p),"SESSION_STATE_MISMATCH",(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];"NoConnection"!==v.state&&(v=m=t$.transition.ConnectedToNoConnection(v,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(m)}}),this.updateSession(v))}else v&&(c="hard reconnection",null==(_=this.log)||_.info("client is reconnecting to a new session (".concat(t.payload.sessionId,") with an old session (").concat(v.id,") already existing, closing old session"),(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,sessionId:t.payload.sessionId})),this.deleteSession(v),v=void 0);if(!v&&(g>0||d>0))return c="unknown session",k=this.options.enableTransparentSessionReconnects?"client is trying to reconnect to a session the server don't know about: ".concat(t.payload.sessionId):"client is attempting a transparent reconnect to a session but the server does not support it: ".concat(t.payload.sessionId),this.rejectHandshakeRequest(e,t.from,k,"SESSION_STATE_MISMATCH",(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(S=t.payload.sessionId,null==(i=this.log)||i.info("handshake from ".concat(t.from," ok (").concat(c,"), responding with handshake success"),(0,u._)((0,l._)({},e.loggingMetadata),{connectedTo:t.from})),w=eT({from:this.clientId,to:t.from,status:{ok:!0,sessionId:S}}),!(b=e.sendHandshake(w)).ok)return null==(C=this.log)||C.error("failed to send handshake response: ".concat(b.reason),(0,u._)((0,l._)({},e.loggingMetadata),{transportMessage:w})),this.protocolError({type:tS.MessageSendFailure,message:b.reason}),this.deletePendingSession(e),[2];if(this.pendingSessions.delete(e),!(E=t$.transition.WaitingForHandshakeToConnected(e,v,S,t.from,t.tracing,{onConnectionErrored:function(e){var t,i=eP(e);null==(t=n.log)||t.warn("connection to ".concat(E.to," errored: ").concat(i),E.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.info("connection to ".concat(E.to," closed"),E.loggingMetadata),n.onConnClosed(E)},onMessage:function(e){n.handleMsg(e)},onInvalidMessage:function(e){var i;null==(i=n.log)||i.error("invalid message: ".concat(e),(0,u._)((0,l._)({},E.loggingMetadata),{transportMessage:t})),n.protocolError({type:tS.InvalidMessage,message:e}),n.deleteSession(E,{unhealthy:!0})},onMessageSendFailure:function(e,t){var i;null==(i=n.log)||i.error("failed to send message: ".concat(t),(0,u._)((0,l._)({},E.loggingMetadata),{transportMessage:e})),n.protocolError({type:tS.MessageSendFailure,message:t}),n.deleteSession(E,{unhealthy:!0})}},s)).sendBufferedMessages().ok)return[2];return this.sessionHandshakeMetadata.set(E.to,o),v?this.updateSession(E):this.createSession(E),E.startActiveHeartbeat(),[2]}})}).call(this)}}]);var t0=function(){function e(){(0,o._)(this,e),(0,a._)(this,"id",void 0),(0,a._)(this,"telemetry",void 0),(0,a._)(this,"dataListener",void 0),(0,a._)(this,"closeListener",void 0),(0,a._)(this,"errorListener",void 0),this.id="conn-".concat(eh())}return(0,r._)(e,[{key:"loggingMetadata",get:function(){var e,t={connId:this.id};if(null==(e=this.telemetry)?void 0:e.span.isRecording()){var n=this.telemetry.span.spanContext();t.telemetry={traceId:n.traceId,spanId:n.spanId}}return t}},{key:"onData",value:function(e){var t;null==(t=this.dataListener)||t.call(this,e)}},{key:"onError",value:function(e){var t;null==(t=this.errorListener)||t.call(this,e)}},{key:"onClose",value:function(){var e,t;null==(e=this.closeListener)||e.call(this),null==(t=this.telemetry)||t.span.end()}},{key:"setDataListener",value:function(e){this.dataListener=e}},{key:"removeDataListener",value:function(){this.dataListener=void 0}},{key:"setCloseListener",value:function(e){this.closeListener=e}},{key:"removeCloseListener",value:function(){this.closeListener=void 0}},{key:"setErrorListener",value:function(e){this.errorListener=e}},{key:"removeErrorListener",value:function(){this.errorListener=void 0}}]),e}(),t1=function(e){function t(e,n){var i;return(0,o._)(this,t),i=(0,eG._)(this,t,["websocket closed with code and reason: ".concat(e," - ").concat(n)]),(0,a._)(i,"code",void 0),(0,a._)(i,"reason",void 0),i.code=e,i.reason=n,i}return(0,eQ._)(t,e),t}((0,eX._)(Error)),t2=function(e){function t(e,n){(0,o._)(this,t),i=(0,eG._)(this,t),(0,a._)(i,"ws",void 0),(0,a._)(i,"extras",void 0),i.ws=e,i.extras=n,i.ws.binaryType="arraybuffer";var i,s=!1;return i.ws.onerror=function(){s=!0},i.ws.onclose=function(e){var t=e.code,n=e.reason;if(s){var o=new t1(t,n);i.onError(o)}i.onClose()},i.ws.onmessage=function(e){i.onData(e.data)},i}return(0,eQ._)(t,e),(0,r._)(t,[{key:"loggingMetadata",get:function(){var e=(0,eJ._)((0,e$._)(t.prototype),"loggingMetadata",this);return this.extras&&(e.extras=this.extras),e}},{key:"send",value:function(e){try{return this.ws.send(e),!0}catch(e){return!1}}},{key:"close",value:function(){this.ws.close(1e3)}}]),t}(t0);e.s(["BinaryCodec",()=>tP,"ClientTransport",()=>tY,"ProtocolError",()=>tS,"WebSocketCloseError",()=>t1,"WebSocketConnection",()=>t2],627922);var t3=function(e){function t(e,n,i){var s;return(0,o._)(this,t),s=(0,eG._)(this,t,[n,i]),(0,a._)(s,"wsGetter",void 0),s.wsGetter=e,s}return(0,eQ._)(t,e),(0,r._)(t,[{key:"createNewOutgoingConnection",value:function(e){return(0,s._)(function(){var t,n,i,s;return(0,f._)(this,function(o){switch(o.label){case 0:return null==(t=this.log)||t.info("establishing a new websocket to ".concat(e),{clientId:this.clientId,connectedTo:e}),[4,this.wsGetter(e)];case 1:return i=o.sent(),[4,new Promise(function(e,t){i.readyState===i.OPEN?e():i.readyState===i.CLOSING||i.readyState===i.CLOSED?t(Error("ws is closing or closed")):(i.onopen=function(){e()},i.onclose=function(e){t(Error(e.reason))},i.onerror=function(e){t(Error(e.message))})})];case 2:return o.sent(),s=new t2(i),null==(n=this.log)||n.info("raw websocket to ".concat(e," ok"),(0,l._)({clientId:this.clientId,connectedTo:e},s.loggingMetadata)),[2,s]}})}).call(this)}}]),t}(tY);e.s(["WebSocketClientTransport",()=>t3],562563)}]);

//# debugId=ad624414-2981-3eee-fb25-50444c135e8d
//# sourceMappingURL=9e5c08ba99a6e7e7.js.map